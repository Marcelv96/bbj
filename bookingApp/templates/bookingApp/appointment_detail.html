{% extends 'bookingApp/base.html' %}
{% block title %}Appointment Detail | BookingApp{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="{% if is_owner %}{% url 'owner_dashboard' appointment.booking_form.business.id %}{% else %}{% url 'my_appointments' %}{% endif %}" class="btn btn-outline-secondary btn-sm rounded-pill px-3">
            &larr; Back
        </a>
        <span id="status-badge" class="badge rounded-pill p-2 px-3 text-uppercase badge-status-{{ appointment.status }}">
            {{ appointment.get_status_display }}
        </span>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm mb-4" style="border-radius: 16px;">
                <div class="card-body p-4">
                    <h2 class="fw-bold mb-1">{{ appointment.service.name }}</h2>
                    <p class="text-muted">Business: <strong>{{ appointment.booking_form.business.name }}</strong></p>

                    <div class="row g-3 py-3 border-top border-bottom my-4">
                        <div class="col-6 col-md-3 text-center">
                            <small class="text-muted d-block small">DATE</small>
                            <span class="fw-bold">{{ appointment.appointment_date }}</span>
                        </div>
                        <div class="col-6 col-md-3 text-center">
                            <small class="text-muted d-block small">TIME</small>
                            <span class="fw-bold">{{ appointment.appointment_start_time }}</span>
                        </div>
                        <div class="col-6 col-md-3 text-center">
                            <small class="text-muted d-block small">STAFF</small>
                            <span class="fw-bold">{{ appointment.staff.name|default:"Any" }}</span>
                        </div>
                        <div class="col-6 col-md-3 text-center">
                            <small class="text-muted d-block small">DURATION</small>
                            <span class="fw-bold">{{ appointment.length_minutes }}m</span>
                        </div>
                    </div>

                    {% if is_owner %}
                        <form id="owner-status-form" method="post" class="p-3 bg-light rounded-3">
                            {% csrf_token %}
                            <label class="form-label small fw-bold">UPDATE STATUS</label>
                            <div class="d-flex gap-2">
                                {{ status_form.status }}
                                <button type="submit" class="btn btn-primary rounded-pill px-4">Save</button>
                            </div>
                        </form>
                    {% elif is_customer %}
                        <div id="customer-actions" class="d-flex gap-2">
                            <button onclick="toggleEdit()" class="btn btn-outline-primary rounded-pill px-4">Edit/Reschedule</button>
                            <button onclick="confirmCancel()" class="btn btn-outline-danger rounded-pill px-4">Cancel Booking</button>
                        </div>

                        <form id="reschedule-form" method="post" class="mt-3 d-none p-4 border rounded-4 shadow-sm bg-white">
                            {% csrf_token %}
                            <input type="hidden" name="reschedule_submit" value="1">
                            <h5 class="fw-bold mb-3">Reschedule Request</h5>
                            <div class="mb-3">{{ reschedule_form.appointment_date }}</div>
                            <div class="mb-3">{{ reschedule_form.appointment_start_time }}</div>
                            <div class="mb-3">{{ reschedule_form.notes }}</div>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-success rounded-pill px-4">Request Update</button>
                                <button type="button" onclick="toggleEdit()" class="btn btn-light rounded-pill px-4">Back</button>
                            </div>
                        </form>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card border-0 shadow-sm rounded-4 p-3">
                <h6 class="fw-bold mb-3">Timeline</h6>
                <div id="timeline-text" class="small text-muted">
                    Last update: <strong>{{ appointment.get_status_display }}</strong>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function toggleEdit() {
    document.getElementById('reschedule-form').classList.toggle('d-none');
    document.getElementById('customer-actions').classList.toggle('d-none');
}

function confirmCancel() {
    if(confirm("Cancel this appointment?")) {
        window.location.href = "{% url 'appointment_cancel' appointment.pk %}";
    }
}

function postData(formId) {
    const form = document.getElementById(formId);
    if (!form) return;

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);

        fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                if(formId === 'reschedule-form') {
                    location.reload(); // Reload for date change
                } else {
                    document.getElementById('status-badge').innerText = data.new_status_display;
                    document.getElementById('status-badge').className = `badge rounded-pill p-2 px-3 text-uppercase badge-status-${data.new_status_raw}`;
                    alert('Status Updated!');
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Update failed. Please refresh and try again.');
        });
    });
}

postData('owner-status-form');
postData('reschedule-form');
</script>

<style>
    .badge-status-pending { background-color: #ffc107; color: #000; }
    .badge-status-confirmed { background-color: #198754; color: #fff; }
    .badge-status-completed { background-color: #0d6efd; color: #fff; }
    .badge-status-cancelled { background-color: #dc3545; color: #fff; }
    .badge-status-reschedule_requested { background-color: #0dcaf0; color: #000; }
</style>
{% endblock %}