{% extends 'bookingApp/base.html' %}
{% block title %}{% if is_editing %}Update Business{% else %}Business Setup{% endif %} | Command Center{% endblock %}

{% block content %}
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
    :root {
        --brand-primary: #4f46e5;
        --brand-success: #10b981;
        --bg-main: #f8fafc;
        --text-main: #1e293b;
    }

    body {
        font-family: 'Plus Jakarta Sans', sans-serif;
        background-color: var(--bg-main);
        color: var(--text-main);
    }

    /* --- SOFT MODERN BACKGROUND --- */
    .viewport-underlay {
        position: fixed;
        inset: 0;
        z-index: -1;
        background: radial-gradient(circle at top right, #e0e7ff 0%, #f8fafc 40%);
    }

    .onboarding-wrapper {
        min-height: 100dvh;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 4rem 1.5rem;
    }

    /* --- SOFT CARD UI --- */
    .modern-card {
        background: white;
        border: 1px solid rgba(0, 0, 0, 0.05);
        width: 100%;
        max-width: 700px;
        border-radius: 1.5rem;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.02);
        overflow: hidden;
    }

    /* --- PROGRESS INDICATOR --- */
    .step-indicator-container {
        padding: 2rem 2.5rem 0 2.5rem;
    }
    .step-track {
        height: 6px;
        background: #f1f5f9;
        border-radius: 10px;
        overflow: hidden;
    }
    .step-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #6366f1, #4f46e5);
        width: 25%;
        transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .main-content { padding: 2.5rem; }

    .h-mega {
        font-size: 1.875rem;
        font-weight: 800;
        letter-spacing: -0.025em;
        color: #0f172a;
        margin-bottom: 0.25rem;
    }

    .sub-mega {
        font-size: 0.875rem;
        font-weight: 500;
        color: #64748b;
        margin-bottom: 2.5rem;
        display: block;
    }

    /* --- FORM STYLING --- */
    .section-header {
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--brand-primary);
        display: block;
        margin-bottom: 1.5rem;
    }

    .field-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: #334155;
        margin-bottom: 0.5rem;
        display: block;
    }

    .form-group { margin-bottom: 1.5rem; }

    input:not([type="checkbox"]):not([type="file"]), select, textarea {
        width: 100% !important;
        background: #ffffff !important;
        border: 1.5px solid #e2e8f0 !important;
        border-radius: 0.5rem !important; /* rounded-sm equivalent but better looking */
        padding: 0.75rem 1rem !important;
        font-size: 0.95rem !important;
        font-weight: 400 !important;
        color: #1e293b !important;
        transition: all 0.2s ease;
    }

    input:focus, select:focus, textarea:focus {
        border-color: var(--brand-primary) !important;
        box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1) !important;
        outline: none !important;
    }

    /* --- BUTTONS --- */
    .btn-modern {
        background: var(--brand-primary);
        color: white;
        padding: 0.875rem 1.5rem;
        font-weight: 600;
        font-size: 0.95rem;
        border-radius: 0.75rem;
        border: none;
        width: 100%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.2s ease;
        box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2);
    }
    .btn-modern:hover {
        background: #4338ca;
        transform: translateY(-1px);
        box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3);
    }

    .btn-ghost {
        margin-top: 1rem;
        width: 100%;
        background: transparent;
        color: #64748b;
        font-weight: 500;
        font-size: 0.875rem;
        cursor: pointer;
        transition: color 0.2s;
    }
    .btn-ghost:hover { color: var(--brand-primary); }

    /* --- PANELS --- */
    .service-row {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 1rem;
    }

    .d-none { display: none; }
</style>

<div class="viewport-underlay"></div>

<div class="onboarding-wrapper">
    <div class="modern-card">
        <div class="step-indicator-container">
            <div class="step-track">
                <div class="step-progress-fill" id="progress-bar"></div>
            </div>
        </div>

        <div class="main-content">
            <header>
                <h1 class="h-mega">{% if is_editing %}Update Business{% else %}Let's set up your shop{% endif %}</h1>
                <span class="sub-mega">Complete these steps to get your booking page live.</span>
            </header>

            <form method="post" enctype="multipart/form-data" id="onboarding-form">
                {% csrf_token %}

                <div class="step-view" id="step-1">
                    <span class="section-header">Step 1: Business Profile</span>
                    
                    <div class="form-group">
                        <label class="field-label">Business Name</label>
                        {{ form.name }}
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="field-label">Industry</label>
                            {{ form.industry }}
                        </div>
                        <div class="form-group">
                            <label class="field-label">Contact Phone</label>
                            {{ form.contact_number }}
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="field-label">Business Address</label>
                        {{ form.address }}
                    </div>

                    <div class="form-group">
                        <label class="field-label">Referral Code (Optional)</label>
                        {{ form.referral_code_input }}
                    </div>

                    <div class="form-group">
                        <label class="field-label">Cover Photo</label>
                        <div class="border-2 border-dashed border-slate-200 rounded-xl p-8 text-center bg-slate-50 hover:bg-slate-100 transition-colors cursor-pointer">
                            {{ form.cover_image }}
                            <p class="text-xs text-slate-400 mt-2">PNG, JPG up to 10MB</p>
                        </div>
                        <div id="image-preview-wrapper" class="hidden mt-4 rounded-xl overflow-hidden shadow-md">
                            <img id="cover-preview" src="#" class="w-full h-40 object-cover">
                        </div>
                    </div>

                    <button type="button" class="btn-modern next-step">
                        Continue to Schedule <i class="fa-solid fa-arrow-right text-xs"></i>
                    </button>
                </div>

                <div class="step-view d-none" id="step-2">
                    <span class="section-header">Step 2: Operating Hours</span>
                    
                    <div class="space-y-3 mb-6">
                        <div class="p-4 border border-slate-100 bg-slate-50 rounded-xl">
                            <label class="field-label">Monday - Friday</label>
                            <div class="grid grid-cols-2 gap-4">
                                {{ form.mon_fri_open }}
                                {{ form.mon_fri_close }}
                            </div>
                        </div>
                        <div class="p-4 border border-slate-100 rounded-xl">
                            <label class="field-label">Saturday</label>
                            <div class="grid grid-cols-2 gap-4">
                                {{ form.sat_open }}
                                {{ form.sat_close }}
                            </div>
                        </div>
                        <div class="p-4 border border-slate-100 rounded-xl">
                            <label class="field-label">Sunday</label>
                            <div class="grid grid-cols-2 gap-4">
                                {{ form.sun_open }}
                                {{ form.sun_close }}
                            </div>
                        </div>
                    </div>

                    <button type="button" class="btn-modern next-step">
                        Continue to Services <i class="fa-solid fa-arrow-right text-xs"></i>
                    </button>
                    <button type="button" class="btn-ghost prev-step">Go back</button>
                </div>

                <div class="step-view d-none" id="step-3">
                    <span class="section-header">Step 3: Services & Pricing</span>
                    
                    <div id="service-container">
                        {{ service_formset.management_form }}
                        {% for sv_form in service_formset %}
                        <div class="service-row">
                            {{ sv_form.id }}
                            <div class="form-group">
                                <label class="field-label">Service Name</label>
                                {{ sv_form.name }}
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="field-label">Price ($)</label>
                                    {{ sv_form.price }}
                                </div>
                                <div>
                                    <label class="field-label">Duration (Mins)</label>
                                    {{ sv_form.default_length_minutes }}
                                </div>
                            </div>
                            <div class="mt-4 flex items-center gap-2">
                                {{ sv_form.DELETE }} <label class="text-xs font-semibold text-red-500">Remove service</label>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <button type="button" id="add-service" class="btn-modern !bg-white !text-indigo-600 border border-indigo-100 mb-6 shadow-none hover:bg-indigo-50">
                        + Add another service
                    </button>

                    <button type="button" class="btn-modern next-step">
                        Almost there: Final Review <i class="fa-solid fa-arrow-right text-xs"></i>
                    </button>
                    <button type="button" class="btn-ghost prev-step">Go back</button>
                </div>

                <div class="step-view d-none" id="step-4">
                    <span class="section-header">Step 4: Socials & Launch</span>
                    
                    <div class="form-group">
                        <label class="field-label">Booking Page URL Name</label>
                        <div class="relative">
                            {{ form.booking_form_name }}
                            <span class="absolute right-3 top-3 text-xs text-slate-400">.yourdomain.com</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="field-label">Business Description</label>
                        {{ form.description }}
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-8">
                        <div class="form-group">
                            <label class="field-label text-[10px]">Instagram</label>
                            {{ form.instagram_url }}
                        </div>
                        <div class="form-group">
                            <label class="field-label text-[10px]">Facebook</label>
                            {{ form.facebook_url }}
                        </div>
                        <div class="form-group">
                            <label class="field-label text-[10px]">Twitter/X</label>
                            {{ form.twitter_url }}
                        </div>
                    </div>

                    <button type="submit" class="btn-modern !bg-emerald-600 !shadow-emerald-200">
                        {% if is_editing %}Save Changes{% else %}Launch Your Platform{% endif %} <i class="fa-solid fa-rocket ml-1"></i>
                    </button>
                    <button type="button" class="btn-ghost prev-step">Go back</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="service-empty-form" class="d-none">
    <div class="service-row">
        <div class="form-group">
            <label class="field-label">Service Name</label>
            {{ service_formset.empty_form.name }}
        </div>
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="field-label">Price</label>
                {{ service_formset.empty_form.price }}
            </div>
            <div>
                <label class="field-label">Duration (Mins)</label>
                {{ service_formset.empty_form.default_length_minutes }}
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        let currentStep = 1;
        const progress = document.getElementById('progress-bar');
        const totalSteps = 4;

        function updateStepUI(n) {
            document.querySelectorAll('.step-view').forEach((v, i) => {
                v.classList.toggle('d-none', i !== (n - 1));
            });
            progress.style.width = (n / totalSteps * 100) + '%';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        document.querySelectorAll('.next-step').forEach(btn => {
            btn.addEventListener('click', () => {
                currentStep++;
                updateStepUI(currentStep);
            });
        });

        document.querySelectorAll('.prev-step').forEach(btn => {
            btn.addEventListener('click', () => {
                currentStep--;
                updateStepUI(currentStep);
            });
        });

        const addBtn = document.getElementById('add-service');
        const container = document.getElementById('service-container');
        const totalForms = document.querySelector('input[name="services-TOTAL_FORMS"]');

        if(addBtn) {
            addBtn.addEventListener('click', () => {
                const count = parseInt(totalForms.value);
                const template = document.getElementById('service-empty-form').innerHTML;
                const newHtml = template.replace(/__prefix__/g, count);
                container.insertAdjacentHTML('beforeend', newHtml);
                totalForms.value = count + 1;
            });
        }

        const coverInput = document.querySelector('input[type="file"]');
        if(coverInput) {
            coverInput.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = e => {
                        document.getElementById('cover-preview').src = e.target.result;
                        document.getElementById('image-preview-wrapper').classList.remove('hidden');
                    }
                    reader.readAsDataURL(file);
                }
            });
        }
    });
</script>
{% endblock %}