{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Book Appointment | {{ business.name }}</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                fontFamily: { sans: ['Inter', 'sans-serif'] },
                extend: {
                    colors: {
                        primary: '#18181b', // Zinc 900
                        secondary: '#71717a', // Zinc 500
                        surface: '#ffffff',
                        subtle: '#f4f4f5', // Zinc 100
                        border: '#e4e4e7', // Zinc 200
                        accent: '#4f46e5', // INDIGO 600
                        'accent-hover': '#4338ca', // Indigo 700
                    },
                    animation: {
                        'enter': 'enter 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: {
                        enter: {
                            '0%': { opacity: '0', transform: 'translateY(8px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #e4e4e7; border-radius: 4px; }
        
        /* Time slot animation */
        .time-slot { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .time-slot:hover:not(.disabled) { border-color: #4f46e5; transform: translateY(-1px); color: #4f46e5; }
        .time-slot.selected { background-color: #4f46e5; color: white; border-color: #4f46e5; box-shadow: 0 4px 10px -2px rgba(79, 70, 229, 0.3); }
        
        /* Step visibility */
        .step-content { display: none; }
        .step-content.active { display: block; animation: enter 0.4s ease-out; }

        /* Loader */
        .loader { border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 2px solid #fff; width: 18px; height: 18px; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Receipt Pattern */
        .receipt-jagged {
            background-image: radial-gradient(circle, transparent 60%, #f4f4f5 60%);
            background-size: 16px 16px;
            background-position: center bottom;
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="bg-gray-50 text-primary h-[100dvh] w-full flex items-center justify-center p-0 sm:p-4 overflow-hidden">

    <div class="w-full h-full sm:h-auto sm:max-h-[90vh] sm:max-w-md bg-surface sm:rounded-3xl shadow-xl flex flex-col relative overflow-hidden border border-border">
        
        <div class="px-6 pt-6 pb-4 border-b border-border z-20 bg-surface/80 backdrop-blur-md sticky top-0">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="font-bold text-lg tracking-tight">{{ business.name }}</h1>
                    <p class="text-xs text-secondary font-medium">New Appointment</p>
                </div>
            </div>

            <div class="flex gap-2 h-1.5 w-full">
                <div id="pb-1" class="h-full w-full rounded-full bg-accent transition-colors duration-300"></div>
                <div id="pb-2" class="h-full w-full rounded-full bg-subtle transition-colors duration-300"></div>
                <div id="pb-3" class="h-full w-full rounded-full bg-subtle transition-colors duration-300"></div>
            </div>
        </div>

        <form method="POST" id="booking-form" action="." class="flex-1 overflow-y-auto custom-scroll relative flex flex-col">
            {% csrf_token %}
            <input type="hidden" name="appointment_start_time" id="hidden-time">

            <div class="p-6 flex-1">
                
                <div id="step-1" class="step-content active space-y-6">
                    <div class="space-y-4">
                        <h2 class="text-xl font-semibold tracking-tight">Select Experience</h2>
                        
                        <div class="space-y-1.5">
                            <label class="text-xs font-semibold uppercase tracking-wider text-secondary ml-1">Treatment</label>
                            <div class="relative">
                                <select name="service" id="svc" class="w-full h-14 pl-4 pr-10 bg-subtle rounded-xl text-sm font-medium border border-transparent focus:bg-white focus:border-accent focus:ring-1 focus:ring-accent outline-none transition-all appearance-none cursor-pointer text-primary" required>
                                    <option value="" disabled selected>Select a service...</option>
                                    {% for s in form.fields.service.queryset %}
                                    <option value="{{ s.id }}" data-price="{{ s.price }}">
                                        {{ s.name }} — R{{ s.price|floatformat:0 }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <i class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-secondary text-xs pointer-events-none"></i>
                            </div>
                        </div>

                        <div class="space-y-1.5">
                            <label class="text-xs font-semibold uppercase tracking-wider text-secondary ml-1">Specialist</label>
                            <div class="relative">
                                <select name="staff" id="stf" class="w-full h-14 pl-4 pr-10 bg-subtle rounded-xl text-sm font-medium border border-transparent focus:bg-white focus:border-accent focus:ring-1 focus:ring-accent outline-none transition-all appearance-none cursor-pointer text-primary">
                                    <option value="">Any Available Specialist</option>
                                    {% for st in form.fields.staff.queryset %}
                                    <option value="{{ st.id }}">{{ st.name }}</option>
                                    {% endfor %}
                                </select>
                                <i class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-secondary text-xs pointer-events-none"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="step-2" class="step-content space-y-6">
                    <h2 class="text-xl font-semibold tracking-tight">Availability</h2>
                    
                    <div class="sticky top-0 bg-surface z-10 pb-2">
                        <div class="relative group">
                            <input type="date" name="appointment_date" id="date-pick" class="w-full h-14 pl-12 pr-4 bg-white border border-border rounded-xl text-sm font-medium focus:border-accent focus:ring-1 focus:ring-accent outline-none transition-all uppercase tracking-wide cursor-pointer text-primary">
                            <i class="fas fa-calendar absolute left-4 top-1/2 -translate-y-1/2 text-accent"></i>
                        </div>
                    </div>

                    <div class="bg-subtle/50 rounded-2xl p-4 border border-border/50 min-h-[200px]">
                        <div id="slot-grid" class="grid grid-cols-3 gap-2">
                            <div class="col-span-3 flex flex-col items-center justify-center py-10 text-secondary">
                                <i class="far fa-clock text-2xl mb-2 opacity-50"></i>
                                <span class="text-sm">Select a date above</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="step-3" class="step-content space-y-6">
                    <h2 class="text-xl font-semibold tracking-tight">Final Details</h2>

                    <div class="space-y-3">
                        <input type="text" name="guest_name" placeholder="Full Name" class="w-full h-12 px-4 bg-white border-b-2 border-border focus:border-accent outline-none transition-colors placeholder:text-secondary/60 text-sm text-primary" required>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="email" name="guest_email" placeholder="Email Address" class="w-full h-12 px-4 bg-white border-b-2 border-border focus:border-accent outline-none transition-colors placeholder:text-secondary/60 text-sm text-primary" required>
                            <input type="tel" name="guest_phone" placeholder="Mobile Number" class="w-full h-12 px-4 bg-white border-b-2 border-border focus:border-accent outline-none transition-colors placeholder:text-secondary/60 text-sm text-primary" required>
                        </div>
                        <textarea name="notes" rows="1" placeholder="Special requests (optional)..." class="w-full p-4 bg-subtle rounded-xl text-sm border-none focus:ring-1 focus:ring-accent outline-none resize-none placeholder:text-secondary/60 text-primary"></textarea>
                    </div>

                    <div class="relative mt-6">
                        <div class="absolute -top-2 left-0 w-full h-4 bg-surface receipt-jagged"></div>
                        
                        <div class="bg-subtle p-6 pt-8 rounded-b-xl space-y-5 border-l border-r border-b border-border/50">
                            
                            <div class="flex justify-between items-start border-b border-dashed border-secondary/20 pb-4">
                                <div>
                                    <span class="text-[10px] uppercase tracking-widest text-secondary block mb-1">Service</span>
                                    <span id="summary-service" class="font-bold text-primary text-sm leading-tight block max-w-[180px]">--</span>
                                </div>
                                <div class="text-right">
                                    <span class="text-[10px] uppercase tracking-widest text-secondary block mb-1">Total Value</span>
                                    <span id="summary-total" class="font-bold text-lg text-primary">R0</span>
                                </div>
                            </div>

                            <div id="deposit-section" class="hidden flex-col gap-3">
                                
                                <div class="flex justify-between items-center bg-white p-3 rounded-lg border border-border shadow-sm">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-accent/10 text-accent flex items-center justify-center text-xs">
                                            <i class="fas fa-wallet"></i>
                                        </div>
                                        <div class="flex flex-col">
                                            <div class="flex items-center gap-2">
                                                <span class="font-bold text-sm text-primary">Deposit Due</span>
                                                <img src="{% static 'img/Payfast.png' %}" alt="PayFast" class="h-3 w-auto opacity-80">
                                            </div>
                                            <span id="deposit-label-detail" class="text-[10px] text-secondary font-medium uppercase tracking-tight">
                                                {% if business.deposit_type == 'percentage' %}
                                                    {{ business.deposit_percentage }}% of total
                                                {% else %}
                                                    Fixed Booking Fee
                                                {% endif %}
                                            </span>
                                        </div>
                                    </div>
                                    <span id="summary-deposit" class="font-bold text-xl text-accent">R0</span>
                                </div>

                                <div class="space-y-2 px-1">
                                    <div class="flex gap-2 text-[11px] text-secondary">
                                        <i class="fas fa-history mt-0.5 text-accent"></i>
                                        <p>
                                            <span class="font-semibold text-primary">Reschedule Policy:</span> 
                                            Free changes allowed up to <span class="font-bold text-primary">{{ business.reschedule_window_hours }} hours</span> before appointment.
                                        </p>
                                    </div>

                                    {% if business.deposit_policy %}
                                    <div class="flex gap-2 text-[11px] text-secondary">
                                        <i class="fas fa-info-circle mt-0.5 text-accent"></i>
                                        <p>
                                            <span class="font-semibold text-primary">Terms:</span> 
                                            {{ business.deposit_policy }}
                                        </p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <div id="no-deposit-msg" class="hidden text-center text-xs text-secondary py-2">
                                <i class="fas fa-check-circle text-green-500 mr-1"></i> No prepayment required. Pay at venue.
                            </div>

                        </div>
                    </div>
                </div>
            </div>
            
            <div class="h-4"></div>
        </form>

        <div class="p-4 bg-surface border-t border-border z-20 flex gap-3 sticky bottom-0">
            <button type="button" id="backBtn" class="hidden w-14 h-14 rounded-xl border border-border text-primary hover:bg-subtle active:scale-95 transition-all flex items-center justify-center bg-white">
                <i class="fas fa-arrow-left"></i>
            </button>

            <button type="button" id="nextBtn" class="flex-1 h-14 bg-accent text-white rounded-xl font-bold text-sm tracking-wide shadow-lg shadow-accent/25 hover:bg-accent-hover active:scale-[0.98] transition-all flex items-center justify-center gap-2 group">
                <span>Continue</span>
                <i class="fas fa-arrow-right text-xs transition-transform group-hover:translate-x-1"></i>
            </button>

            <button type="submit" form="booking-form" id="subBtn" class="hidden flex-1 h-14 bg-accent text-white rounded-xl font-bold text-sm tracking-wide shadow-lg shadow-accent/25 hover:bg-accent-hover active:scale-[0.98] transition-all flex items-center justify-center gap-2 disabled:opacity-70 disabled:cursor-not-allowed">
                <span class="btn-text">Complete Booking</span>
                <span class="loader hidden"></span>
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let step = 1;
            const maxSteps = 3;
            
            const els = {
                next: document.getElementById('nextBtn'),
                back: document.getElementById('backBtn'),
                submit: document.getElementById('subBtn'),
                svc: document.getElementById('svc'),
                stf: document.getElementById('stf'),
                date: document.getElementById('date-pick'),
                grid: document.getElementById('slot-grid'),
                hiddenTime: document.getElementById('hidden-time'),
                bars: [document.getElementById('pb-1'), document.getElementById('pb-2'), document.getElementById('pb-3')],
                panels: [document.getElementById('step-1'), document.getElementById('step-2'), document.getElementById('step-3')],
                
                sumService: document.getElementById('summary-service'),
                sumTotal: document.getElementById('summary-total'),
                sumDeposit: document.getElementById('summary-deposit'),
                depSection: document.getElementById('deposit-section'),
                noDepMsg: document.getElementById('no-deposit-msg'),
                subText: document.querySelector('#subBtn .btn-text'),
                loader: document.querySelector('#subBtn .loader')
            };

            const config = {
                depType: "{{ business.deposit_type }}",
                depFixed: parseFloat("{{ business.deposit_amount|default:0 }}"),
                depPercent: parseFloat("{{ business.deposit_percentage|default:0 }}"),
                hasPayfast: "{{ business.payfast_merchant_id }}" !== "None" && "{{ business.payfast_merchant_id }}" !== ""
            };

            els.date.min = new Date().toISOString().split("T")[0];

            // UI Updates with Accent Color Logic
            const updateUI = () => {
                els.panels.forEach((p, i) => {
                    p.classList.toggle('active', i + 1 === step);
                    p.classList.toggle('hidden', i + 1 !== step);
                });
                els.bars.forEach((b, i) => {
                    // Update progress bars to use Indigo (accent)
                    b.classList.toggle('bg-accent', i + 1 <= step);
                    b.classList.toggle('bg-subtle', i + 1 > step);
                });

                els.back.classList.toggle('hidden', step === 1);
                els.next.classList.toggle('hidden', step === maxSteps);
                els.submit.classList.toggle('hidden', step !== maxSteps);

                if (step === 3) calculateSummary();
            };

            els.next.addEventListener('click', () => {
                if (step === 1 && !els.svc.value) {
                    els.svc.classList.add('ring-2', 'ring-red-500', 'ring-offset-1');
                    setTimeout(() => els.svc.classList.remove('ring-2', 'ring-red-500', 'ring-offset-1'), 500);
                    return;
                }
                if (step === 2 && !els.hiddenTime.value) {
                    alert("Please select a time slot.");
                    return;
                }
                step++;
                updateUI();
            });

            els.back.addEventListener('click', () => {
                step--;
                updateUI();
            });

            // Get Staff
            els.svc.addEventListener('change', async () => {
                const svcId = els.svc.value;
                if (!svcId) return;
                
                els.date.value = ''; 
                els.grid.innerHTML = '<div class="col-span-3 text-center py-10 text-secondary"><i class="far fa-clock text-2xl mb-2 opacity-50"></i><span class="text-sm block">Select a date</span></div>';

                const oldText = els.stf.options[els.stf.selectedIndex].text;
                els.stf.innerHTML = '<option>Loading...</option>';
                
                try {
                    const res = await fetch(`{% url 'get_staff_for_service' %}?service_id=${svcId}`);
                    const data = await res.json();
                    
                    els.stf.innerHTML = '<option value="">Any Available Specialist</option>';
                    data.staff_list.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.id;
                        opt.textContent = s.name;
                        els.stf.appendChild(opt);
                    });
                } catch (e) {
                    els.stf.innerHTML = `<option value="">${oldText}</option>`;
                }
            });

            // Get Slots
            const getSlots = async () => {
                const sId = els.svc.value;
                const date = els.date.value;
                const stId = els.stf.value;

                if (!sId || !date) return;

                els.grid.innerHTML = '<div class="col-span-3 flex justify-center py-8"><span class="loader border-stone-400 border-t-accent"></span></div>';

                try {
                    const res = await fetch(`/ajax/available-slots/?business_id={{ business.id }}&service_id=${sId}&date=${date}&staff_id=${stId}`, {
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    });
                    const data = await res.json();

                    els.grid.innerHTML = '';
                    if (data.slots.length > 0) {
                        data.slots.forEach(slot => {
                            const btn = document.createElement('div');
                            // Updated slot styling for interaction
                            btn.className = 'time-slot py-3 px-1 rounded-lg text-center text-xs font-bold cursor-pointer border border-border bg-white text-secondary';
                            btn.innerText = slot.label;
                            btn.onclick = () => {
                                document.querySelectorAll('.time-slot').forEach(e => e.classList.remove('selected'));
                                btn.classList.add('selected');
                                els.hiddenTime.value = slot.value;
                            };
                            els.grid.appendChild(btn);
                        });
                    } else {
                        els.grid.innerHTML = '<div class="col-span-3 text-center py-6 bg-subtle rounded-lg border border-dashed border-border"><p class="text-secondary font-medium text-xs">No slots available</p></div>';
                    }
                } catch (e) {
                    els.grid.innerHTML = '<p class="text-center text-red-500 text-xs col-span-3">Network error</p>';
                }
            };
            els.date.addEventListener('change', getSlots);
            els.stf.addEventListener('change', getSlots);

            // Summary
            const calculateSummary = () => {
                const opt = els.svc.options[els.svc.selectedIndex];
                const price = parseFloat(opt.getAttribute('data-price') || 0);
                const name = opt.text.split(" — ")[0];

                els.sumService.innerText = name;
                els.sumTotal.innerText = `R${price.toFixed(0)}`;

                let depositAmount = 0;
                if (config.hasPayfast) {
                    if (config.depType === 'percentage') {
                        depositAmount = (config.depPercent / 100) * price;
                    } else {
                        depositAmount = config.depFixed;
                    }
                }

                if (depositAmount > 0) {
                    els.depSection.classList.remove('hidden');
                    els.depSection.classList.add('flex');
                    els.noDepMsg.classList.add('hidden');
                    
                    els.sumDeposit.innerText = `R${depositAmount.toFixed(0)}`;
                    els.subText.innerText = `Pay R${depositAmount.toFixed(0)} & Book`;
                } else {
                    els.depSection.classList.add('hidden');
                    els.depSection.classList.remove('flex');
                    els.noDepMsg.classList.remove('hidden');
                    
                    els.subText.innerText = "Confirm Appointment";
                }
            };

            document.getElementById('booking-form').onsubmit = () => {
                els.submit.disabled = true;
                els.subText.classList.add('hidden');
                els.loader.classList.remove('hidden');
                els.loader.classList.add('inline-block');
            };
        });
    </script>
</body>
</html>