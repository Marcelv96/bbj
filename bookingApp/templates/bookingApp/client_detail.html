{% extends "bookingApp/base.html" %}
{% block content %}
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
    
    /* Clean, high-contrast toggle */
    .toggle-checkbox:checked {
        right: 0;
        border-color: #111827; /* Near black for professional look */
    }
    .toggle-checkbox:checked + .toggle-label {
        background-color: #111827;
    }
</style>

<div class="min-h-screen pb-12">
    
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="{% url 'client-list' %}" class="w-10 h-10 flex items-center justify-center rounded-md hover:bg-gray-100 text-gray-500 hover:text-gray-900 transition-colors">
                    <i class="fa-solid fa-arrow-left text-lg"></i>
                </a>
                <h1 class="text-xl font-bold text-gray-900">Client Profile</h1>
            </div>
            
            {% if client.is_overdue %}
            <span class="inline-flex items-center gap-1.5 px-3 py-1 bg-red-50 text-red-700 border border-red-200 rounded text-xs font-bold uppercase tracking-wide">
                <i class="fa-solid fa-circle-exclamation"></i> Overdue
            </span>
            {% endif %}
        </div>
    </header>

    <main class="max-w-5xl mx-auto px-4 py-6 space-y-6">
        
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
            {% include "bookingApp/partials/client_info_card.html" with editing=False %}
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-white p-4 border border-gray-200 rounded-lg shadow-sm">
                <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Total Spent</p>
                <p class="mt-1 text-2xl font-bold text-gray-900 tabular-nums">R{{ client.total_spent|floatformat:0 }}</p>
            </div>
            <div class="bg-white p-4 border border-gray-200 rounded-lg shadow-sm">
                <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Deposits</p>
                <p class="mt-1 text-2xl font-bold text-indigo-600 tabular-nums">R{{ client.total_deposit_paid|floatformat:0 }}</p>
            </div>
            <div class="bg-white p-4 border border-gray-200 rounded-lg shadow-sm">
                <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Bookings</p>
                <p class="mt-1 text-2xl font-bold text-gray-900">{{ client.appointment_count }}</p>
            </div>
            <div class="bg-white p-4 border border-gray-200 rounded-lg shadow-sm">
                <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Preference</p>
                <p class="mt-1 text-sm font-bold text-gray-900 truncate leading-8">{{ client.most_selected_service|default:"-" }}</p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            
            <div class="bg-white p-4 border border-gray-200 rounded-lg shadow-sm space-y-3">
                <h3 class="text-xs font-bold text-gray-900 uppercase">Contact</h3>
                <div class="grid grid-cols-2 gap-3">
                    {% if client.rebook_whatsapp_link %}
                    <a href="{{ client.rebook_whatsapp_link }}" target="_blank" class="flex flex-col items-center justify-center p-3 bg-emerald-50 border border-emerald-100 rounded text-emerald-700 hover:bg-emerald-100 transition-colors text-center">
                        <i class="fa-brands fa-whatsapp text-xl mb-1"></i>
                        <span class="text-xs font-bold">WhatsApp</span>
                    </a>
                    {% else %}
                    <div class="flex flex-col items-center justify-center p-3 bg-gray-50 border border-gray-100 rounded text-gray-400 opacity-50 cursor-not-allowed">
                        <i class="fa-brands fa-whatsapp text-xl mb-1"></i>
                        <span class="text-xs font-bold">No Number</span>
                    </div>
                    {% endif %}
                    
                    {% if client.email %}
                    <a href="{{ client.rebook_email_link }}" class="flex flex-col items-center justify-center p-3 bg-gray-50 border border-gray-200 rounded text-gray-700 hover:bg-gray-100 transition-colors text-center">
                        <i class="fa-regular fa-envelope text-xl mb-1"></i>
                        <span class="text-xs font-bold">Email</span>
                    </a>
                    {% else %}
                    <div class="flex flex-col items-center justify-center p-3 bg-gray-50 border border-gray-100 rounded text-gray-400 opacity-50 cursor-not-allowed">
                        <i class="fa-regular fa-envelope text-xl mb-1"></i>
                        <span class="text-xs font-bold">No Email</span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="bg-white p-4 border border-gray-200 rounded-lg shadow-sm flex flex-col justify-between">
                <div>
                    <h3 class="text-xs font-bold text-gray-900 uppercase mb-2">Configuration</h3>
                    <div class="flex items-center justify-between py-2">
                        <div>
                            <span class="block text-sm font-semibold text-gray-900">Deposit Exemption</span>
                            <span class="block text-xs text-gray-500">Allow booking without payment</span>
                        </div>
                        <form hx-post="{% url 'toggle_client_exemption' client.id %}" hx-trigger="change" hx-target="this" hx-swap="outerHTML" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
                            <div class="relative inline-block w-10 align-middle select-none">
                                <input type="checkbox" name="exempt" id="exempt-toggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 border-gray-200 appearance-none cursor-pointer transition-all duration-300 ease-in-out" {% if client.deposit_exempt %}checked{% endif %}/>
                                <label for="exempt-toggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-200 cursor-pointer transition-colors duration-300 ease-in-out"></label>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-200 bg-gray-50 flex items-center justify-between">
                <h3 class="text-sm font-bold text-gray-900">Appointment History</h3>
                <span class="text-xs font-medium text-gray-500">{{ appointments|length }} records</span>
            </div>

            <div class="divide-y divide-gray-100">
                {% for apt in appointments %}
                <div class="p-4 sm:px-6 hover:bg-gray-50 transition-colors flex items-center gap-4">
                    <div class="flex-shrink-0 w-12 text-center">
                        <span class="block text-lg font-bold text-gray-900 leading-none">{{ apt.appointment_date|date:"d" }}</span>
                        <span class="block text-[10px] font-bold text-gray-500 uppercase mt-0.5">{{ apt.appointment_date|date:"M" }}</span>
                    </div>

                    <div class="flex-grow min-w-0">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center">
                            <h4 class="text-sm font-bold text-gray-900 truncate">{{ apt.service.name }}</h4>
                            <span class="text-sm font-medium text-gray-900 sm:hidden">R{{ apt.amount_to_pay|floatformat:0 }}</span>
                        </div>
                        
                        <div class="flex flex-wrap items-center gap-x-3 gap-y-1 mt-1">
                            <span class="text-xs text-gray-500 flex items-center gap-1">
                                <i class="fa-regular fa-clock text-[10px]"></i> {{ apt.appointment_start_time|time:"H:i" }}
                            </span>
                            
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider
                                {% if apt.status == 'completed' %}text-emerald-700 bg-emerald-50
                                {% elif apt.status == 'confirmed' %}text-indigo-700 bg-indigo-50
                                {% elif apt.status == 'cancelled' %}text-red-600 bg-red-50
                                {% else %}text-amber-600 bg-amber-50{% endif %}">
                                {{ apt.status }}
                            </span>
                        </div>
                    </div>

                    <div class="hidden sm:block text-right">
                        <span class="text-sm font-bold text-gray-900">R{{ apt.amount_to_pay|floatformat:2 }}</span>
                    </div>
                </div>
                {% empty %}
                <div class="px-6 py-12 text-center text-gray-500">
                    <p class="text-sm">No appointment history found.</p>
                </div>
                {% endfor %}
            </div>
        </div>

    </main>
</div>
{% endblock %}