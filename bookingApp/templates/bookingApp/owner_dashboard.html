{% extends 'bookingApp/base.html' %}
{% load custom_filters %}
{% load static %}
{% block title %}{{ business.name }} | Owner Dashboard{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<style>
    /* --- 1. PROFESSIONAL THEME VARIABLES --- */
    :root {
        --primary: #4f46e5; /* Indigo 600 */
        --primary-dark: #4338ca; /* Indigo 700 */
        --secondary: #64748b; /* Slate 500 */
        --bg-body: #f8fafc; /* Slate 50 */
        --bg-card: #ffffff;
        --border-subtle: #e2e8f0; /* Slate 200 */
        --text-main: #0f172a; /* Slate 900 */
    }

    body {
        background-color: var(--bg-body);
        font-family: 'Inter', sans-serif;
        color: var(--text-main);
        -webkit-font-smoothing: antialiased;
    }

    /* --- 2. LAYOUT UTILITIES --- */
    .app-container {
        max-width: 1280px;
        margin: 0 auto;
        padding: 0 1.5rem;
    }

    @media (max-width: 640px) {
        .app-container { padding: 0 0.75rem; } /* Reduced padding for mobile wide-view */
    }

    /* Cards - Modified for professional mobile appearance */
    .feature-card {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: 0.75rem;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        transition: all 0.2s ease-in-out;
        overflow: hidden;
    }

    @media (max-width: 640px) {
        .feature-card {
            border-radius: 0; /* Flat look on mobile for edge-to-edge feel */
            border-left: none;
            border-right: none;
            box-shadow: none;
        }
        .tab-pane { padding-top: 0.5rem; }
    }

    .feature-card:hover {
        border-color: var(--primary);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        transform: translateY(-2px);
    }

    /* --- 3. NAVIGATION TABS --- */
    .sticky-nav {
        position: sticky;
        top: 0;
        z-index: 40;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(8px);
        border-bottom: 1px solid var(--border-subtle);
    }

    .nav-tab {
        position: relative;
        padding: 1rem 0.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--secondary);
        transition: color 0.2s;
        white-space: nowrap;
        background: none;
        border: none;
        cursor: pointer;
    }

    .nav-tab:hover { color: var(--primary); }
    .nav-tab.active { color: var(--primary); }

    .nav-tab.active::after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 0;
        right: 0;
        height: 2px;
        background-color: var(--primary);
    }

    /* --- 4. FORM ELEMENTS --- */
    .input-std {
        width: 100%;
        background: #fff;
        border: 1px solid #cbd5e1;
        border-radius: 0.5rem;
        padding: 0.625rem 0.875rem;
        font-size: 1rem; /* Better for mobile zoom prevention */
        color: #334155;
        outline: none;
        transition: border-color 0.15s;
    }

    @media (min-width: 640px) {
        .input-std { font-size: 0.875rem; }
    }

    .input-std:focus { border-color: var(--primary); ring: 2px solid #e0e7ff; }

    .btn-main {
        background-color: var(--primary);
        color: white;
        font-weight: 600;
        padding: 0.625rem 1.25rem;
        border-radius: 0.2rem;
        font-size: 0.875rem;
        transition: background-color 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }
    .btn-main:hover { background-color: black; }

    .btn-outline {
        background-color: white;
        border: 1px solid #cbd5e1;
        color: #475569;
        font-weight: 600;
        padding: 0.625rem 1.25rem;
        border-radius: 0.2rem;
        font-size: 0.875rem;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }
    .btn-outline:hover { border-color: var(--primary); color: var(--primary); background: #f8fafc; }

    /* --- 5. UTILS --- */
    .mini-heading {
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--secondary);
        margin-bottom: 0.5rem;
    }

    /* Calendar Overrides */
    .fc { font-family: 'Inter', sans-serif; --fc-border-color: #e2e8f0; --fc-button-bg-color: #4f46e5; --fc-button-border-color: #4f46e5; }
    .fc .fc-toolbar-title { font-size: 1.1rem; font-weight: 700; color: #1e293b; }
    @media (min-width: 640px) { .fc .fc-toolbar-title { font-size: 1.25rem; } }
    .fc-theme-standard .fc-scrollgrid { border: none; }

    /* Scrollbar for nav */
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* Mobile Modal Form Improvements */
    @media (max-width: 640px) {
        #settings-modal-overlay > div {
            max-width: 100%;
            height: 100%;
            max-height: 100vh;
            border-radius: 0;
        }
        .modal-pane { padding-bottom: 2rem; }
    }
</style>



<header class="bg-white pt-6 md:pt-8 pb-2">
    <div class="app-container">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">

            <div class="flex items-center gap-3 md:gap-4">

                <div>
                    <div class="flex items-center gap-2">
                        <h1 class="text-2xl md:text-3xl font-bold text-slate-900 leading-tight">{{ business.name }}</h1>
                        <button onclick="toggleHelpModal2()" class="text-slate-400 hover:text-indigo-600 transition-colors p-1" title="Help">
                            <i class="fa-regular fa-circle-question text-lg"></i>
                        </button>
                    </div>
                    <div class="flex items-center gap-2 mt-1">

                        <a href="{% url 'business_detail' business.id %}" target="_blank" class="text-xs font-medium text-slate-500 hover:text-indigo-600 transition-colors">
                           View Public Page <i class="fa-solid fa-arrow-up-right-from-square ml-0.5"></i>
                        </a>
                    </div>
                </div>
            </div>

            <div class="hidden md:flex items-center gap-2 md:gap-3 mt-2 md:mt-0">
                <a href="{% url 'master_appointments' business.id %}" class="btn-main whitespace-nowrap py-2 px-4 text-xs">
                    <i class="fa-regular fa-calendar-check"></i> Bookings
                </a>
                <a href="{% url 'analytics_dashboard' %}" class="btn-outline whitespace-nowrap py-2 px-4 text-xs">
                    <i class="fa fa-bar-chart"></i> Insights
                </a>
                <a href="{% url 'client-list' %}" class="btn-outline whitespace-nowrap py-2 px-4 text-xs">
                    <i class="fa-solid fa-users"></i> Clients
                </a>
            </div>

        </div>
    </div>
</header>
{% if days_left <= 5 %}
<div class="bg-red-50 border-b mt-3 border-red-100 text-red text-[11px] md:text-xs font-bold text-center py-2 px-4">
    <i class="fa-solid fa-circle-exclamation mr-2"></i>
    Subscription expires in {{ days_left }} days.
    {% if request.user == business.owner %}
    <a href="{{ pay_url }}" class="underline hover:text-amber-900 ml-1">Renew Now</a>
    {% endif %}
</div>
{% endif %}

<nav class="sticky-nav mt-3">
    <div class="app-container">
        <div class="flex gap-4 md:gap-6 overflow-x-auto hide-scrollbar">
            <button class="nav-tab active" onclick="switchDashTab(event, 'dash-team')">
                Team
            </button>
            <button class="nav-tab" onclick="switchDashTab(event, 'dash-links')">
                Portals
            </button>
            <button class="nav-tab" onclick="switchDashTab(event, 'dash-services')">
                Services
            </button>
            {% if user == business.owner %}
            <button class="nav-tab" onclick="switchDashTab(event, 'dash-settings')">
                Settings
            </button>
            {% endif %}
        </div>
    </div>
</nav>

<main class="py-4 md:py-8 min-h-screen">
    <div class="app-container">

<section id="dash-team" class="tab-pane animate-fade-in py-4">
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-8 pb-6 border-b border-slate-200">
        <div>
            <h2 class="text-2xl font-bold text-slate-900">Team Management</h2>
            <p class="text-sm text-slate-500">Manage staff access and view organization members.</p>
        </div>

        <div class="flex items-center bg-slate-100 border border-slate-200 rounded-sm p-1.5 pl-4 w-full md:w-auto">
            <div class="flex flex-col mr-8">
                <span class="text-[9px] font-black uppercase tracking-widest text-slate-400">Join Code</span>
                <code class="text-lg font-mono font-bold text-indigo-700" id="joinCodeText">{{ business.join_code }}</code>
            </div>
            <button onclick="copyJoinCode(this)" class="bg-white border border-slate-300 text-slate-700 px-4 py-2 text-xs font-bold uppercase hover:bg-slate-50 transition-all shadow-sm active:shadow-none">
                Copy
            </button>
        </div>
    </div>

    <div class="hidden md:block bg-white border border-slate-200 shadow-sm overflow-visible">
        <table class="w-full text-left border-collapse">
            <thead>
                <tr class="bg-slate-50 border-b border-slate-200">
                    <th class="px-6 py-4 text-[11px] font-bold uppercase tracking-wider text-slate-500">Staff Member</th>
                    <th class="px-6 py-4 text-[11px] font-bold uppercase tracking-wider text-slate-500">Email Address</th>
                    <th class="px-6 py-4 text-[11px] font-bold uppercase tracking-wider text-slate-500">Role</th>
                    <th class="px-6 py-4 text-[11px] font-bold uppercase tracking-wider text-slate-500">Status</th>
                    <th class="px-6 py-4 text-[11px] font-bold uppercase tracking-wider text-slate-500 text-right">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
                {% for s in staff_members %}
                <tr class="hover:bg-slate-50/50 transition-colors">
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 shrink-0 bg-slate-200 border border-slate-300 flex items-center justify-center overflow-hidden rounded-sm {% if not s.is_active %}grayscale opacity-50{% endif %}">
                                {% if s.user.profile.avatar %}
                                    <img src="{{ s.user.profile.avatar.url }}" class="w-full h-full object-cover">
                                {% else %}
                                    <span class="text-xs font-bold text-slate-600 uppercase">{{ s.name|slice:":1" }}</span>
                                {% endif %}
                            </div>
                            <div>
                                <span class="font-semibold text-slate-900 text-sm block {% if not s.is_active %}text-slate-400 line-through decoration-slate-400{% endif %}">
                                    {{ s.name }}
                                    {% if s.user == business.owner %}
                                        <span class="ml-1 text-[10px] text-indigo-600 font-black uppercase tracking-tighter">(You)</span>
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </td>

                    <td class="px-6 py-4 text-sm text-slate-600 font-medium">
                        {{ s.email|default:"â€”" }}
                    </td>

                    <td class="px-6 py-4">
                        {% if s.user == business.owner %}
                            <span class="text-[10px] font-black uppercase tracking-widest text-indigo-700 bg-indigo-50 border border-indigo-200 px-2 py-1 rounded">Owner</span>
                        {% else %}
                            <span class="text-xs font-medium text-slate-500 bg-slate-100 px-2 py-1 rounded">{{ s.role|default:"Staff" }}</span>
                        {% endif %}
                    </td>

                    <td class="px-6 py-4">
                        {% if s.is_active %}
                            <span class="inline-flex items-center px-2 py-0.5 text-[10px] font-bold uppercase tracking-wide bg-emerald-100 text-emerald-800 border border-emerald-200 rounded-sm">Active</span>
                        {% else %}
                            <span class="inline-flex items-center px-2 py-0.5 text-[10px] font-bold uppercase tracking-wide bg-slate-100 text-slate-500 border border-slate-200 rounded-sm">Inactive</span>
                        {% endif %}
                    </td>

                    <td class="px-6 py-4 text-right">
                        {% if s.user != business.owner %}
                        <div class="relative inline-block text-left">
                            <button type="button" onclick="toggleStaffMenu('menu-{{ s.id }}')" class="text-slate-400 hover:text-indigo-600 p-2 rounded-full hover:bg-slate-100 transition-colors focus:outline-none">
                                <i class="fa-solid fa-ellipsis-vertical text-lg"></i>
                            </button>

                            <div id="menu-{{ s.id }}" class="hidden absolute right-0 mt-2 w-52 bg-white rounded-lg shadow-xl z-[9999] border border-slate-200 ring-1 ring-black ring-opacity-5 overflow-hidden">
                                <div class="flex flex-col">

                                    <div class="px-4 py-3 border-t border-slate-100 bg-slate-50/30">
                                        <label class="text-[9px] font-semibold text-slate-400 uppercase tracking-wider mb-2 block">Account Role</label>
                                        <form method="POST" class="m-0">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="update_staff_role">
                                            <input type="hidden" name="staff_id" value="{{ s.id }}">
                                            <select name="role" onchange="this.form.submit()" class="w-full text-[11px] border-slate-200 rounded-md py-1.5 px-2 bg-white text-slate-700 focus:outline-none focus:ring-1 focus:ring-indigo-500 transition-all">
                                                <option value="Staff" {% if s.role == "Staff" %}selected{% endif %}>Staff Member</option>
                                                <option value="Admin/Co-Owner" {% if s.role == "Admin/Co-Owner" %}selected{% endif %}>Admin</option>
                                            </select>
                                        </form>
                                    </div>
                                    <form method="POST" class="m-0">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="toggle_staff_status">
                                        <input type="hidden" name="staff_id" value="{{ s.id }}">
                                        <button type="submit" class="w-full text-left px-4 py-3 text-[11px] font-medium text-slate-700 hover:bg-slate-50 flex items-center gap-3 transition-colors">
                                            <i class="fa-solid fa-power-off {% if s.is_active %}text-amber-500{% else %}text-emerald-500{% endif %} w-4"></i>
                                            {% if s.is_active %}Deactivate Member{% else %}Activate Member{% endif %}
                                        </button>
                                    </form>

                                    <div class="border-t border-slate-100">
                                        <form method="POST" class="m-0" onsubmit="return confirm('Permanently delete {{ s.name }}?');">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="delete_staff">
                                            <input type="hidden" name="staff_id" value="{{ s.id }}">
                                            <button type="submit" class="w-full text-left px-4 py-3 text-[11px] font-medium text-red-600 hover:bg-red-50 flex items-center gap-3 transition-colors">
                                                <i class="fa-solid fa-trash-can w-4"></i>
                                                Remove Staff Member
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <span class="text-[10px] font-bold text-slate-300 italic pr-2">Restricted</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="md:hidden space-y-3">
        {% for s in staff_members %}
        <div class="bg-white border border-slate-200 p-4 shadow-sm rounded-md relative overflow-visible">
            <div class="flex justify-between items-start">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 shrink-0 bg-slate-100 border border-slate-200 flex items-center justify-center rounded-sm {% if not s.is_active %}grayscale opacity-50{% endif %}">
                        {% if s.user.profile.avatar %}
                            <img src="{{ s.user.profile.avatar.url }}" class="w-full h-full object-cover rounded-sm">
                        {% else %}
                            <span class="text-xs font-bold text-slate-600 uppercase">{{ s.name|slice:":1" }}</span>
                        {% endif %}
                    </div>
                    <div>
                        <h4 class="font-bold text-slate-900 text-sm {% if not s.is_active %}line-through text-slate-400{% endif %}">
                            {{ s.name }} {% if s.user == business.owner %}(Owner){% endif %}
                        </h4>
                        <p class="text-[11px] text-slate-500 font-medium truncate">{{ s.email|default:"No email" }}</p>

                        <div class="flex gap-2 mt-1">
                            {% if s.is_active %}
                                <span class="text-[9px] font-bold uppercase text-emerald-600 bg-emerald-50 px-1.5 py-0.5 rounded border border-emerald-100">Active</span>
                            {% else %}
                                <span class="text-[9px] font-bold uppercase text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded border border-slate-200">Inactive</span>
                            {% endif %}

                            {% if s.user == business.owner %}
                                <span class="text-[9px] font-black uppercase text-indigo-700 bg-indigo-50 px-1.5 py-0.5 rounded border border-indigo-200">Owner</span>
                            {% else %}
                                <span class="text-[9px] font-bold uppercase text-indigo-600 bg-indigo-50 px-1.5 py-0.5 rounded border border-indigo-100">{{ s.role|default:"Staff" }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                {% if s.user != business.owner %}
                <div class="relative z-50">
                    <button onclick="toggleStaffMenu('m-menu-{{ s.id }}')" class="text-slate-400 p-2 hover:text-indigo-600">
                        <i class="fa-solid fa-ellipsis-v text-lg"></i>
                    </button>

                    <div id="m-menu-{{ s.id }}" class="hidden absolute right-0 top-full mt-2 w-56 bg-white rounded-lg shadow-2xl z-[100] border border-slate-200 ring-1 ring-black ring-opacity-10 overflow-hidden">
    <div class="px-4 py-2.5 bg-slate-50 border-b border-slate-100">
        <span class="text-[10px] font-bold uppercase tracking-widest text-slate-400">Staff Settings</span>
    </div>

    <div class="flex flex-col">

        <div class="px-4 py-4 border-t border-slate-100">
            <label class="text-[9px] font-bold text-slate-400 uppercase mb-2 block">Change Permissions</label>
            <form method="POST" class="m-0">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_staff_role">
                <input type="hidden" name="staff_id" value="{{ s.id }}">
                <select name="role" onchange="this.form.submit()" class="w-full text-xs border-slate-200 rounded-md p-3 bg-slate-50 text-slate-700 focus:ring-1 focus:ring-indigo-500 appearance-none">
                    <option value="Staff" {% if s.role == "Staff" %}selected{% endif %}>Standard Staff</option>
                    <option value="Admin/Co-Owner" {% if s.role == "Admin/Co-Owner" %}selected{% endif %}>Admin</option>
                </select>
            </form>
        </div>

        <form method="POST" class="m-0">
            {% csrf_token %}
            <input type="hidden" name="action" value="toggle_staff_status">
            <input type="hidden" name="staff_id" value="{{ s.id }}">
            <button type="submit" class="w-full text-left px-4 py-4 text-xs font-medium text-slate-700 active:bg-slate-100 flex items-center gap-4">
                <i class="fa-solid fa-power-off {% if s.is_active %}text-amber-500{% else %}text-emerald-500{% endif %} w-4"></i>
                {% if s.is_active %}Deactivate Member{% else %}Activate Member{% endif %}
            </button>
        </form>

        <div class="mt-2 border-t border-slate-100 bg-red-50/10">
            <form method="POST" class="m-0" onsubmit="return confirm('Delete {{ s.name }} permanently?');">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete_staff">
                <input type="hidden" name="staff_id" value="{{ s.id }}">
                <button type="submit" class="w-full text-left px-4 py-4 text-xs font-semibold text-red-600 active:bg-red-100 flex items-center gap-4">
                    <i class="fa-solid fa-trash-can w-4 text-red-400"></i>
                    Delete Permanently
                </button>
            </form>
        </div>
    </div>
</div>
                </div>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="p-8 text-center text-slate-400 italic text-sm border-2 border-dashed border-slate-200 rounded-md">
            No staff members found.
        </div>
        {% endfor %}
    </div>
</section>

<script>
function toggleStaffMenu(menuId) {
    const targetMenu = document.getElementById(menuId);
    const isHidden = targetMenu.classList.contains('hidden');

    // Close all menus first
    document.querySelectorAll('[id^="menu-"], [id^="m-menu-"]').forEach(menu => menu.classList.add('hidden'));

    // Toggle the target
    if (isHidden) {
        targetMenu.classList.remove('hidden');
    }
}

// Global click listener to close dropdowns
document.addEventListener('mousedown', function(event) {
    if (!event.target.closest('.relative')) {
        document.querySelectorAll('[id^="menu-"], [id^="m-menu-"]').forEach(menu => menu.classList.add('hidden'));
    }
});

function copyJoinCode(btn) {
    const codeText = document.getElementById('joinCodeText').innerText;
    navigator.clipboard.writeText(codeText).then(() => {
        const originalText = btn.innerText;
        btn.innerText = 'COPIED';
        btn.classList.replace('bg-white', 'bg-emerald-600');
        btn.classList.replace('text-slate-700', 'text-white');
        setTimeout(() => {
            btn.innerText = originalText;
            btn.classList.replace('bg-emerald-600', 'bg-white');
            btn.classList.replace('text-white', 'text-slate-700');
        }, 1500);
    });
}
</script>

 <section id="dash-links" class="tab-pane hidden animate-fade-in py-4">
    {% with form=business.booking_form %}
    {% if form %}

    <div class="flex flex-col md:flex-row md:items-end justify-between mb-8 pb-6 border-b border-slate-100 gap-4">
        <div>
            <h2 class="text-2xl font-bold text-slate-900 tracking-tight">Booking Portals</h2>
            <p class="text-sm text-slate-500 font-medium mt-1">Direct access links and website integration.</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-stretch">

        <div class="lg:col-span-7 bg-white border border-slate-200 rounded-xl p-6 sm:p-8 shadow-sm">
            <div class="flex items-center justify-between mb-6">
                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em]">Production Endpoint</label>
                <a href="{{ request.scheme }}://{{ request.get_host }}/book/{{ business.slug }}/" target="_blank"
                   class="flex items-center gap-1.5 text-xs font-bold text-indigo-600 hover:text-indigo-700 transition-colors">
                    TEST PORTAL <i class="fa-solid fa-arrow-up-right-from-square text-[10px]"></i>
                </a>
            </div>

            <div class="flex items-center gap-2 mb-8">
                <div class="relative flex-grow">
                    <input type="text" value="{{ request.scheme }}://{{ request.get_host }}/book/{{ business.slug }}/" id="link_main" readonly
                           class="w-full h-10 px-4 bg-slate-50 border border-slate-200 rounded-lg font-mono text-xs text-slate-600 focus:outline-none focus:border-slate-300 transition-all">
                </div>
                <button onclick="copyAction('link_main')" class="btn-main hover:bg-slate-800 transition-all flex items-center gap-2 shrink-0 active:scale-95">
                    <i class="fa-regular fa-copy"></i> COPY
                </button>
            </div>

            <div class="flex flex-wrap items-center gap-x-8 gap-y-4 pt-6 border-t border-slate-50">
                <div class="flex items-center gap-2 text-slate-400">
                    <span class="text-[10px] font-bold uppercase tracking-widest">Share link:</span>
                </div>
                <a href="https://wa.me/?text=Book%20here:%20{{ request.scheme }}://{{ request.get_host }}/book/{{ business.slug }}/" target="_blank"
                   class="text-xs font-bold text-slate-600 hover:text-emerald-600 flex items-center gap-2 transition-colors">
                    <i class="fa-brands fa-whatsapp text-lg text-emerald-500"></i> WhatsApp
                </a>
                <a href="mailto:?subject=Booking%20Link&body=Book%20here:%20{{ request.scheme }}://{{ request.get_host }}/book/{{ business.slug }}/"
                   class="text-xs font-bold text-slate-600 hover:text-indigo-600 flex items-center gap-2 transition-colors">
                    <i class="fa-solid fa-envelope text-indigo-500"></i> Email
                </a>
            </div>
        </div>

        <div class="lg:col-span-5 bg-white border border-slate-200 rounded-xl p-6 sm:p-8 shadow-sm flex flex-col">
            <div class="mb-6">
                <h3 class="text-sm font-bold text-slate-900 uppercase tracking-tight">Website Widget</h3>
                <p class="text-[11px] text-slate-500 mt-1">Embed a "Book Now" button on your domain.</p>
            </div>

            <div class="bg-slate-50 border border-slate-100 rounded-lg p-6 mb-8 flex flex-col items-center justify-center border-dashed">
                <button class="btn-main py-2 px-6 text-xs rounded-full shadow-lg shadow-indigo-100 pointer-events-none">
                    Book Now
                </button>
                <span class="text-[9px] text-slate-400 mt-3 font-bold uppercase tracking-[0.15em]">Preview On Site</span>
            </div>

            <button onclick="copyEmbedSnippet('{{ business.slug }}', 'embedBtn_main')" id="embedBtn_main"
                    class="mt-auto w-full py-3 bg-white border border-slate-900 text-slate-900 hover:bg-slate-900 hover:text-indigo-500 transition-all rounded-lg text-xs font-bold flex items-center justify-center gap-2">
                <i class="fa-solid fa-code text-xs"></i> COPY WIDGET CODE
            </button>
        </div>
    </div>

    {% else %}
    <div class="py-16 border border-slate-200 rounded-xl text-center bg-white shadow-sm">
        <div class="mb-4 inline-flex items-center justify-center w-12 h-12 bg-slate-50 rounded-full text-slate-300">
            <i class="fa-solid fa-link-slash text-xl"></i>
        </div>
        <h3 class="font-bold text-slate-900 uppercase tracking-tight text-sm">No Active Deployment</h3>
        <p class="text-xs text-slate-500 mt-1 mb-8">Generate a booking form to create your portal access points.</p>
        <a href="{% url 'create_booking_form' %}" class="inline-flex h-10 px-8 items-center bg-indigo-600 text-white rounded-lg font-bold text-xs shadow-lg shadow-indigo-100 hover:bg-indigo-700 transition-all">
            CREATE PORTAL
        </a>
    </div>
    {% endif %}
    {% endwith %}
</section>
<section id="dash-services" class="tab-pane hidden animate-fade-in py-4">
    <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-6">
        <div>
            <h2 class="text-2xl font-bold text-slate-900">Service Menu</h2>
            <p class="text-sm text-slate-500">Manage your service offerings and pricing.</p>
        </div>
        <a href="{% url 'service_create' business.id %}" class="btn-main py-2 text-xs shadow-md shadow-indigo-100">
            <i class="fa-solid fa-plus"></i> <span class="ml-1">Add Service</span>
        </a>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4">
        {% for s in services %}
        <div class="group bg-white rounded-lg border border-slate-200 shadow-sm hover:shadow-md hover:border-indigo-400 transition-all duration-200 p-4 flex flex-col justify-between min-h-[110px]">

            <div class="flex justify-between items-start mb-2">
                <div class="pr-4">
                    <h3 class="font-bold text-sm text-slate-900 leading-tight group-hover:text-indigo-700 transition-colors">
                        {{ s.name }}
                    </h3>
                    {% if s.description %}
                    <p class="text-[11px] text-slate-500 mt-1 leading-snug line-clamp-1" title="{{ s.description }}">
                        {{ s.description }}
                    </p>
                    {% else %}
                    <p class="text-[11px] text-slate-300 mt-1 italic">No description</p>
                    {% endif %}
                </div>

                <div class="flex items-center gap-1 opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity">
                    <a href="{% url 'service_edit' business.id s.id %}"
                       class="w-7 h-7 flex items-center justify-center rounded text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 transition-all"
                       title="Edit">
                        <i class="fa-solid fa-pen text-xs"></i>
                    </a>
                    <form action="{% url 'service_delete' business.id s.id %}" method="POST" class="m-0">
                        {% csrf_token %}
                        <button type="submit"
                                onclick="return confirm('Delete {{ s.name }}?');"
                                class="w-7 h-7 flex items-center justify-center rounded text-slate-400 hover:text-red-600 hover:bg-red-50 transition-all"
                                title="Delete">
                            <i class="fa-solid fa-trash-can text-xs"></i>
                        </button>
                    </form>
                </div>
            </div>

            <div class="flex items-center gap-3 pt-3 border-t border-slate-50 mt-1">
                <span class="inline-block text-xs font-bold text-indigo-700 bg-indigo-50 px-2 py-0.5 rounded border border-indigo-100">
                    R{{ s.price|floatformat:0 }}
                </span>
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider flex items-center gap-1">
                    <i class="fa-regular fa-clock"></i> {{ s.default_length_minutes }}m
                </span>
            </div>

        </div>
        {% empty %}
        <div class="col-span-full py-12 flex flex-col items-center justify-center text-center border-2 border-dashed border-slate-200 rounded-lg bg-slate-50/50">
            <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm border border-slate-200 mb-3 text-slate-300">
                <i class="fa-solid fa-plus text-lg"></i>
            </div>
            <h3 class="text-slate-900 font-bold text-sm">No services yet</h3>
            <a href="{% url 'service_create' business.id %}" class="text-indigo-600 hover:text-indigo-800 text-xs font-bold mt-1">
                Add your first service
            </a>
        </div>
        {% endfor %}
    </div>
</section>
        {% if user == business.owner %}
        <section id="dash-settings" class="tab-pane hidden px-3 animate-fade-in">
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">

        <div class="feature-card p-6 cursor-pointer hover:shadow-md transition-shadow bg-white rounded-lg border border-slate-200" onclick="openSettingsModal('modal-profile', 'Business Identity')">
            <div class="w-12 h-12 rounded-md bg-indigo-50 text-indigo-600 flex items-center justify-center text-xl mb-4">
                <i class="fa-solid fa-store"></i>
            </div>
            <h3 class="font-bold text-slate-900">Business Profile</h3>
            <p class="text-sm text-slate-500 mt-1">Update name, logo, industry, contact details and address.</p>
        </div>

        <div class="feature-card p-6 cursor-pointer hover:shadow-md transition-shadow bg-white rounded-lg border border-slate-200" onclick="openSettingsModal('modal-messages', 'Message Settings')">
            <div class="w-12 h-12 rounded-md bg-indigo-50 text-indigo-600 flex items-center justify-center text-xl mb-4">
                <i class="fa-solid fa-envelope-open-text"></i>
            </div>
            <h3 class="font-bold text-slate-900">Custom Messages</h3>
            <p class="text-sm text-slate-500 mt-1">Personalize your email notifications and confirmations.</p>
        </div>

        <div class="feature-card p-6 cursor-pointer hover:shadow-md transition-shadow bg-white rounded-lg border border-slate-200" onclick="openSettingsModal('modal-hours', 'Schedule & Blocks')">
            <div class="w-12 h-12 rounded-md bg-indigo-50 text-indigo-600 flex items-center justify-center text-xl mb-4">
                <i class="fa-solid fa-clock"></i>
            </div>
            <h3 class="font-bold text-slate-900">Operating Hours</h3>
            <p class="text-sm text-slate-500 mt-1">Set weekly hours and manage blocked/holiday dates.</p>
        </div>

        <div class="feature-card p-6 cursor-pointer hover:shadow-md transition-shadow bg-white rounded-lg border border-slate-200" onclick="openSettingsModal('modal-pay', 'Payment Gateway')">
            <div class="w-12 h-12 rounded-md bg-indigo-50 text-indigo-600 flex items-center justify-center text-xl mb-4">
                <i class="fa-solid fa-credit-card"></i>
            </div>
            <h3 class="font-bold text-slate-900">Payments & Deposits</h3>
            <p class="text-sm text-slate-500 mt-1">Configure PayFast integration and deposit rules.</p>
        </div>

        <div class="feature-card p-6 cursor-pointer hover:shadow-md transition-shadow bg-white rounded-lg border border-slate-200" onclick="openSettingsModal('modal-refer', 'Referral Rewards')">
            <div class="w-12 h-12 rounded-md bg-indigo-50 text-indigo-600 flex items-center justify-center text-xl mb-4">
                <i class="fa-solid fa-gift"></i>
            </div>
            <h3 class="font-bold text-slate-900">Referral Program</h3>
            <p class="text-sm text-slate-500 mt-1">Get free subscription months by inviting others.</p>
        </div>

        <div class="feature-card p-6 cursor-pointer hover:shadow-md transition-shadow bg-white rounded-lg border border-slate-300" onclick="openSettingsModal('modal-sub', 'Subscription Plan')">
            <div class="w-12 h-12 rounded-md bg-indigo-100 text-indigo-700 flex items-center justify-center text-xl mb-4">
                <i class="fa-solid fa-receipt"></i>
            </div>
            <h3 class="font-bold text-slate-900">Billing & Plan</h3>
            <p class="text-sm text-slate-500 mt-1">
                {% if days_left > 0 %}
                    Active: <span class="text-emerald-600 font-bold">{{ days_left }} Days left</span>
                {% else %}
                    <span class="text-red-600 font-bold">Subscription Expired</span>
                {% endif %}
            </p>
        </div>
    </div>
</section>
        {% endif %}
    </div>
</main>

<div id="settings-modal-overlay" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 hidden transition-opacity duration-300 opacity-0 flex items-center justify-center p-0 md:p-4">

    <div id="settings-modal-container" class="bg-white w-full max-w-2xl max-h-full md:max-h-[90vh] flex flex-col shadow-2xl md:rounded-md overflow-hidden transform transition-all duration-300 scale-95 opacity-0">

        <div class="px-3 py-3 border-b border-slate-100 flex justify-between items-center bg-slate-50 sticky top-0 z-10">
            <h3 id="modal-display-title" class="font-bold uppercase text-xs tracking-widest text-slate-500">Settings</h3>
            <button onclick="closeSettingsModal()" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-slate-200 text-slate-400 transition-colors">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
        </div>

        <div class="p-4 md:p-5 overflow-y-auto">

            <div id="modal-profile" class="modal-pane hidden">
                <div class="bg-white border border-gray-200 rounded-lg shadow-sm flex flex-col h-full">
                    <div class="bg-gray-50 border-b border-gray-200 px-4 py-3 flex items-center justify-between rounded-t-lg shrink-0">
                        <div class="flex items-center gap-3">
                            <h3 class="text-gray-900 font-semibold text-sm">Business Profile</h3>
                        </div>
                        <div class="flex items-center gap-1.5 text-gray-700 bg-gray-100 border border-gray-200 px-2 py-0.5 rounded text-xs font-medium">
                            <i class="fa-solid fa-store text-[10px]"></i>
                            <span>General Info</span>
                        </div>
                    </div>

                    <form method="POST" enctype="multipart/form-data" class="flex flex-col h-full">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="update_profile">

                        <div class="p-4 space-y-6 bg-white grow">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Brand Visuals</label>
                                <div class="flex items-center gap-4 p-3 border border-gray-200 rounded-sm bg-gray-50">
                                    {% if business.cover_image %}
                                        <img src="{{ business.cover_image.url }}" class="h-12 w-12 object-cover rounded-sm border border-gray-200 shadow-sm">
                                    {% endif %}
                                    <input type="file" name="cover_image" accept="image/*" class="text-xs text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-sm file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Name</label>
                                    <input type="text" name="name" value="{{ business.name }}" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-sm shadow-sm placeholder-gray-400" required>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Contact Number</label>
                                    <input type="text" name="phone_number" value="{{ business.contact_number }}" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-sm shadow-sm placeholder-gray-400" required>
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Address</label>
                                <input type="text" name="address" value="{{ business.address }}" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-sm shadow-sm placeholder-gray-400" required>
                            </div>

                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Description</label>
                                <textarea name="description" rows="3" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-sm shadow-sm placeholder-gray-400" placeholder="Describe your business...">{{ business.description|default:'' }}</textarea>
                            </div>

                            <div class="border-t border-gray-100 pt-2"></div>
                            <div>
                                <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-3">Social Media Integration</h3>
                                <div class="space-y-3">
                                    <div class="relative rounded-sm shadow-sm">
                                        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3 border-r border-gray-200 w-10 justify-center">
                                            <i class="fa-brands fa-instagram text-gray-400"></i>
                                        </div>
                                        <input type="url" name="instagram_url" value="{{ business.instagram_url|default:'' }}" placeholder="instagram.com/yourbrand" class="block w-full rounded-sm border-gray-300 pl-12 py-2 focus:border-indigo-500 focus:ring-indigo-500 text-sm placeholder-gray-400">
                                    </div>
                                    <div class="relative rounded-sm shadow-sm">
                                        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3 border-r border-gray-200 w-10 justify-center">
                                            <i class="fa-brands fa-facebook-f text-gray-400 text-xs"></i>
                                        </div>
                                        <input type="url" name="facebook_url" value="{{ business.facebook_url|default:'' }}" placeholder="facebook.com/yourbrand" class="block w-full rounded-sm border-gray-300 pl-12 py-2 focus:border-indigo-500 focus:ring-indigo-500 text-sm placeholder-gray-400">
                                    </div>
                                    <div class="relative rounded-sm shadow-sm">
                                        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3 border-r border-gray-200 w-10 justify-center">
                                            <i class="fa-brands fa-x-twitter text-gray-400"></i>
                                        </div>
                                        <input type="url" name="twitter_url" value="{{ business.twitter_url|default:'' }}" placeholder="x.com/yourbrand" class="block w-full rounded-sm border-gray-300 pl-12 py-2 focus:border-indigo-500 focus:ring-indigo-500 text-sm placeholder-gray-400">
                                    </div>
                                    <div class="relative rounded-sm shadow-sm">
                                        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3 border-r border-gray-200 w-10 justify-center">
                                            <i class="fa-solid fa-globe text-gray-400 text-sm"></i>
                                        </div>
                                        <input type="url" name="website_url" value="{{ business.website_url|default:'' }}" placeholder="https://www.yourbusiness.com/" class="block w-full rounded-sm border-gray-300 pl-12 py-2 focus:border-indigo-500 focus:ring-indigo-500 text-sm placeholder-gray-400">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="px-4 py-3 bg-gray-50 border-t border-gray-200 flex items-center justify-end rounded-b-lg shrink-0">
                            <button type="submit" class="bg-indigo-600 hover:bg-slate-800 text-white font-medium py-2 px-4 rounded-sm shadow-sm text-xs uppercase tracking-wider transition-all">
                                Update Business Profile
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="modal-messages" class="modal-pane hidden">
                <div class="bg-white border border-gray-200 rounded-lg shadow-sm flex flex-col h-full">
                    <div class="bg-gray-50 border-b border-gray-200 px-4 py-3 flex items-center justify-between rounded-t-lg shrink-0">
                        <div class="flex items-center gap-3">
                            <h3 class="text-gray-900 font-semibold text-sm">Custom Messages</h3>
                        </div>
                        <div class="flex items-center gap-1.5 text-gray-700 bg-gray-100 border border-gray-200 px-2 py-0.5 rounded text-xs font-medium">
                            <i class="fa-solid fa-envelope text-[10px]"></i>
                            <span>Notifications</span>
                        </div>
                    </div>

                    <form method="POST" class="flex flex-col h-full">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="update_profile"> <div class="p-4 space-y-6 bg-white grow">
                            <div>
                                <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-3">Email Customization</h3>

                                <div class="mb-4 p-3 bg-blue-50 border border-blue-100 rounded-sm">
                                    <div class="flex gap-2">
                                        <i class="fa-solid fa-circle-info text-blue-500 mt-0.5 text-xs"></i>
                                        <div>
                                            <p class="text-[11px] leading-relaxed text-blue-900 mb-2">
                                                <strong>Personalize your emails:</strong> Copy these tags to insert details:
                                            </p>
                                            <div class="flex flex-wrap gap-2">
                                                {% verbatim %}
                                                <span class="font-mono text-[10px] bg-white px-2 py-1 rounded border border-blue-200 text-blue-800 shadow-sm">{{ guest_name }}</span>
                                                <span class="font-mono text-[10px] bg-white px-2 py-1 rounded border border-blue-200 text-blue-800 shadow-sm">{{ business_name }}</span>
                                                <span class="font-mono text-[10px] bg-white px-2 py-1 rounded border border-blue-200 text-blue-800 shadow-sm">{{ service_name }}</span>
                                                <span class="font-mono text-[10px] bg-white px-2 py-1 rounded border border-blue-200 text-blue-800 shadow-sm">{{ date }}</span>
                                                <span class="font-mono text-[10px] bg-white px-2 py-1 rounded border border-blue-200 text-blue-800 shadow-sm">{{ time }}</span>
                                                {% endverbatim %}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="space-y-5">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Deposit Request Message</label>
                                        {% verbatim %}<textarea name="custom_deposit_message" rows="3" placeholder="Hi {{ guest_name }}, please pay your deposit for {{ service_name }}." class="w-full px-3 py-2 bg-white border border-gray-300 rounded-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-sm shadow-sm placeholder-gray-400">{% endverbatim %}{{ business.custom_deposit_message|default_if_none:"" }}</textarea>
                                        <p class="mt-1 text-[10px] text-gray-500">Sent when a booking requires a deposit.</p>
                                    </div>

                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Booking Confirmation Message</label>
                                        {% verbatim %}<textarea name="custom_confirmation_message" rows="3" placeholder="Your spot is locked in! See you on {{ date }}." class="w-full px-3 py-2 bg-white border border-gray-300 rounded-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-sm shadow-sm placeholder-gray-400">{% endverbatim %}{{ business.custom_confirmation_message|default_if_none:"" }}</textarea>
                                        <p class="mt-1 text-[10px] text-gray-500">Sent immediately after confirmation.</p>
                                    </div>

                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Cancellation Message</label>
                                        {% verbatim %}<textarea name="custom_cancellation_message" rows="3" placeholder="We're sorry you couldn't make it, {{ guest_name }}." class="w-full px-3 py-2 bg-white border border-gray-300 rounded-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-sm shadow-sm placeholder-gray-400">{% endverbatim %}{{ business.custom_cancellation_message|default_if_none:"" }}</textarea>
                                        <p class="mt-1 text-[10px] text-gray-500">Sent if the appointment is cancelled.</p>
                                    </div>

                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Thank You / Review Request</label>
                                        {% verbatim %}<textarea name="custom_thank_you_message" rows="3" placeholder="Thanks for visiting {{ business_name }}!" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-sm shadow-sm placeholder-gray-400">{% endverbatim %}{{ business.custom_thank_you_message|default_if_none:"" }}</textarea>
                                        <p class="mt-1 text-[10px] text-gray-500">Sent after the appointment is marked as completed.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="px-4 py-3 bg-gray-50 border-t border-gray-200 flex items-center justify-end rounded-b-lg shrink-0">
                            <button type="submit" class="bg-indigo-600 hover:bg-slate-800 text-white font-medium py-2 px-4 rounded-sm shadow-sm text-xs uppercase tracking-wider transition-all">
                                Update Messages
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="modal-hours" class="modal-pane hidden">
                <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
                    <div class="bg-gray-50 border-b border-gray-200 px-4 py-3 flex items-center justify-between rounded-t-lg">
                        <div class="flex items-center gap-3">
                            <h3 class="text-gray-900 font-semibold text-sm">Schedule & Blocked Dates</h3>
                        </div>
                        <div class="flex items-center gap-1.5 px-2 py-0.5 rounded text-xs font-medium text-indigo-700 bg-indigo-50 border border-indigo-200">
                            <i class="fa-solid fa-clock text-[10px]"></i>
                            <span>Availability</span>
                        </div>
                    </div>

                    <form method="POST" class="w-full">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="update_hours">

                        <div class="p-4 space-y-6 bg-white">
                            <p class="text-xs text-gray-500">Set your availability and the required gap between appointments.</p>

                            <div class="grid grid-cols-1 md:grid-cols-2 items-center gap-4 bg-gray-50 p-4 rounded-sm border border-gray-200">
                                <div>
                                    <label class="block text-xs font-bold uppercase tracking-widest text-gray-600 mb-1">Booking Buffer</label>
                                    <p class="text-[11px] text-gray-400">Minutes required between sessions.</p>
                                </div>
                                <div class="relative max-w-[160px] ml-auto">
                                    <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none">
                                        <i class="fa-solid fa-hourglass-half text-xs"></i>
                                    </div>
                                    <input type="number" name="buffer_time" value="{{ business.buffer_time|default:0 }}" class="w-full pl-9 pr-3 py-2 bg-white border border-gray-300 rounded-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-sm shadow-sm placeholder-gray-400" min="0" step="5">
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs font-bold uppercase tracking-widest text-gray-500 mb-3">Weekly Operating Hours</label>
                                <div class="flex items-center justify-between p-3 border-b border-gray-100 hover:bg-gray-50 transition-colors">
                                    <div class="flex items-center gap-3">
                                        <div class="w-2 h-2 rounded-full bg-indigo-500"></div>
                                        <span class="text-sm font-medium text-gray-700">Weekdays</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="time" name="open_mon_fri" value="{{ operating_hours.mon_fri.open_time|time:'H:i' }}" class="w-28 px-2 py-1.5 bg-white border border-gray-300 rounded-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-sm shadow-sm">
                                        <span class="text-gray-300 text-xs">â€”</span>
                                        <input type="time" name="close_mon_fri" value="{{ operating_hours.mon_fri.close_time|time:'H:i' }}" class="w-28 px-2 py-1.5 bg-white border border-gray-300 rounded-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-sm shadow-sm">
                                    </div>
                                </div>
                                <div class="flex items-center justify-between p-3 border-b border-gray-100 hover:bg-gray-50 transition-colors">
                                    <div class="flex items-center gap-3">
                                        <div class="w-2 h-2 rounded-full bg-slate-300"></div>
                                        <span class="text-sm font-medium text-gray-700">Saturday</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="time" name="open_sat" value="{{ operating_hours.sat.open_time|time:'H:i' }}" class="w-28 px-2 py-1.5 bg-white border border-gray-300 rounded-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-sm shadow-sm">
                                        <span class="text-gray-300 text-xs">â€”</span>
                                        <input type="time" name="close_sat" value="{{ operating_hours.sat.close_time|time:'H:i' }}" class="w-28 px-2 py-1.5 bg-white border border-gray-300 rounded-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-sm shadow-sm">
                                    </div>
                                </div>
                                <div class="flex items-center justify-between p-3 hover:bg-gray-50 transition-colors">
                                    <div class="flex items-center gap-3">
                                        <div class="w-2 h-2 rounded-full bg-slate-200"></div>
                                        <span class="text-sm font-medium text-gray-400">Sunday</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="time" name="open_sun" value="{{ operating_hours.sun.open_time|time:'H:i' }}" class="w-28 px-2 py-1.5 bg-white border border-gray-300 rounded-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-sm shadow-sm">
                                        <span class="text-gray-300 text-xs">â€”</span>
                                        <input type="time" name="close_sun" value="{{ operating_hours.sun.close_time|time:'H:i' }}" class="w-28 px-2 py-1.5 bg-white border border-gray-300 rounded-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-sm shadow-sm">
                                    </div>
                                </div>
                            </div>

                            <div class="flex justify-end">
                                <button type="submit" class="bg-indigo-600 hover:bg-black text-white text-xs font-medium py-2 px-4 rounded-sm shadow-sm transition-colors uppercase tracking-wider">
                                    Update Hours
                                </button>
                            </div>
                        </div>
                    </form>

                    <div class="border-t border-gray-200"></div>

                    <div class="p-4 space-y-4 bg-white rounded-b-lg">
                        <div class="flex items-center gap-2 mb-2">
                             <i class="fa-solid fa-ban text-red-500 text-xs"></i>
                             <h4 class="text-xs font-bold uppercase tracking-widest text-gray-600">Block Specific Dates</h4>
                        </div>

                        <form method="POST" class="flex flex-col sm:flex-row gap-3">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="add_block">
                            <div class="grow">
                                <input type="date" name="block_date" required class="w-full px-3 py-2 bg-white border border-gray-300 rounded-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-sm shadow-sm text-gray-700">
                            </div>
                            <button type="submit" class="bg-gray-800 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-sm shadow-sm text-xs uppercase tracking-wider whitespace-nowrap transition-colors">
                                Block Date
                            </button>
                        </form>

                        <div class="space-y-2 max-h-[150px] overflow-y-auto pr-1">
                            {% for block in business_blocks %}
                            <div class="flex justify-between items-center bg-gray-50 p-2 border border-gray-200 rounded-sm">
                                <span class="text-sm font-bold text-gray-700">{{ block.block_date|date:"d M Y" }}</span>
                                <form method="POST" class="m-0">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="delete_block">
                                    <input type="hidden" name="block_id" value="{{ block.id }}">
                                    <button type="submit" class="w-6 h-6 flex items-center justify-center text-gray-400 hover:text-red-500 transition-colors">
                                        <i class="fa-solid fa-trash-can text-sm"></i>
                                    </button>
                                </form>
                            </div>
                            {% empty %}
                            <div class="text-center py-4 bg-gray-50 border border-dashed border-gray-200 rounded-sm">
                                <p class="text-gray-400 text-xs italic">No dates currently blocked</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <div id="modal-pay" class="modal-pane hidden">
                <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
                    <div class="bg-gray-50 border-b border-gray-200 px-4 py-3 flex items-center justify-between rounded-t-lg">
                        <div class="flex items-center gap-3">
                            <img src="{% static 'img/Payfast.png' %}" alt="PayFast" class="h-6 w-auto object-contain">
                            <span class="h-4 w-px bg-gray-300"></span>
                            <h3 class="text-gray-900 font-semibold text-sm">Deposit Settings</h3>
                        </div>
                        <div class="flex items-center gap-1.5 text-emerald-700 bg-emerald-50 border border-emerald-200 px-2 py-0.5 rounded text-xs font-medium">
                            <i class="fa-solid fa-lock text-[10px]"></i>
                            <span>TLS Encrypted</span>
                        </div>
                    </div>

                    <form method="POST" action="{% url 'owner_dashboard' business.id %}" id="payfast-form">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="update_payfast">

                        <div class="px-4 py-3 bg-white border-b border-gray-100 flex items-center justify-between">
                            <div>
                                <div class="flex items-center gap-2">
                                    <h4 class="font-medium text-gray-900 text-sm">Enable Upfront Deposits</h4>
                                    <span id="save-status" class="text-xs font-semibold opacity-0 transition-opacity duration-300"></span>
                                </div>
                                <p class="text-gray-500 text-xs mt-0.5">Require payment before booking confirmation.</p>
                            </div>

                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="enable_deposits" id="depositToggle" class="sr-only peer" {% if business.deposit_enabled %}checked{% endif %}>
                                <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-indigo-500/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-600"></div>
                            </label>
                        </div>

                        <div id="payfast-error" class="hidden mx-4 mt-3 flex items-center gap-2 px-3 py-2 text-xs text-red-700 bg-red-50 border border-red-200 rounded-sm">
                            <i class="fa-solid fa-circle-exclamation text-red-600"></i>
                            <span id="payfast-error-text" class="font-medium"></span>
                        </div>

                        <div id="settingsContainer" class="transition-opacity duration-200">
                            <div class="p-4 space-y-5 bg-white">
                                <div>
                                    <div class="flex items-center justify-between mb-3">
                                        <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wide">PayFast Credentials</h4>
                                        <a href="https://my.payfast.io/settings/developer-settings" target="_blank" class="text-xs text-indigo-600 hover:text-indigo-800 hover:underline">
                                            Get credentials <i class="fa-solid fa-arrow-up-right-from-square text-[10px] ml-0.5"></i>
                                        </a>
                                    </div>

                                    <div class="mb-4 p-2 bg-indigo-50 border border-indigo-100 rounded-sm">
                                        <div class="flex gap-2">
                                            <i class="fa-solid fa-circle-info text-indigo-500 mt-0.5 text-xs"></i>
                                            <p class="text-[11px] leading-relaxed text-indigo-900">
                                                <strong>Important:</strong> Ensure <strong>"Enable Signature"</strong> is toggled <strong>ON</strong> in your PayFast Developer Settings. Your Merchant ID and Key must be correct, and your Passphrase (if set or if blank) must match exactly on both PayFast and GetMeBooked.
                                            </p>
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Merchant ID <span class="text-red-500">*</span></label>
                                            <input type="text" name="payfast_merchant_id" id="mid" value="{{ business.payfast_merchant_id|default:'' }}" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 font-mono text-sm text-gray-900 shadow-sm placeholder-gray-400 payfast-req" placeholder="10000100">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Merchant Key <span class="text-red-500">*</span></label>
                                            <input type="password" name="payfast_merchant_key" id="mkey" value="{{ business.payfast_merchant_key|default:'' }}" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 font-mono text-sm text-gray-900 shadow-sm placeholder-gray-400 payfast-req" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Passphrase</label>
                                            <input type="password" name="payfast_passphrase" id="pphrase" value="{{ business.payfast_passphrase|default:'' }}" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 font-mono text-sm text-gray-900 shadow-sm placeholder-gray-400" placeholder="Only if set in PayFast">
                                            <p class="mt-1 text-[10px] text-gray-500 leading-tight">Must match your PayFast "Passphrase" setting exactly. Leave blank if not set.</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="border-t border-gray-100"></div>

                                <div>
                                    <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-3">Booking Rules</h4>

                                    <div class="grid grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Deposit Method</label>
                                            <select name="deposit_type" id="deposit_type_select" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-sm shadow-sm">
                                                <option value="fixed" {% if business.deposit_type == 'fixed' %}selected{% endif %}>Fixed Amount (R)</option>
                                                <option value="percentage" {% if business.deposit_type == 'percentage' %}selected{% endif %}>Percentage (%)</option>
                                            </select>
                                        </div>
                                        <div>
                                            <div id="fixed_amount_container">
                                                <label class="block text-xs font-medium text-gray-700 mb-1">Amount (ZAR)</label>
                                                <div class="relative rounded-sm shadow-sm">
                                                    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                                        <span class="text-gray-500 sm:text-sm">R</span>
                                                    </div>
                                                    <input type="number" step="0.01" name="deposit_amount" value="{{ business.deposit_amount|default:'0.00' }}" class="block w-full rounded-sm border-gray-300 pl-7 py-2 focus:border-indigo-500 focus:ring-indigo-500 text-sm">
                                                </div>
                                            </div>
                                            <div id="percentage_container" class="hidden">
                                                <label class="block text-xs font-medium text-gray-700 mb-1">Percentage</label>
                                                <div class="relative rounded-sm shadow-sm">
                                                    <input type="number" name="deposit_percentage" value="{{ business.deposit_percentage|default:'50' }}" min="1" max="100" class="block w-full rounded-sm border-gray-300 px-3 py-2 focus:border-indigo-500 focus:ring-indigo-500 text-sm">
                                                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3">
                                                        <span class="text-gray-500 sm:text-sm">%</span>
                                                    </div>
                                                </div>
                                                <p class="text-[10px] text-gray-500 mt-1.5 flex items-center gap-1">
                                                    <i class="fa-solid fa-circle-info text-[9px]"></i>
                                                    Calculated as a percentage of the total price of the selected service.
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-1 gap-4">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Reschedule Window</label>
                                            <div class="flex items-center">
                                                <input type="number" name="reschedule_window_hours" value="{{ business.reschedule_window_hours|default:'24' }}" min="0" class="w-24 px-3 py-2 bg-white border border-gray-300 rounded-l-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-sm shadow-sm">
                                                <span class="bg-gray-50 border border-l-0 border-gray-300 text-gray-500 text-xs px-3 py-2.5 rounded-r-sm font-medium">Hours before booking</span>
                                            </div>
                                            <p class="text-xs text-slate-500 mt-1">Changes within this timeframe are treated as a no-show and the deposit is forfeited. Changes made outside the timeframe, deposits are fully refundable via PayFast.</p>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Cancellation Policy</label>
                                            <textarea name="deposit_policy" rows="2" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-sm shadow-sm placeholder-gray-400" placeholder="Terms regarding refunds...">{{ business.deposit_policy }}</textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="px-4 py-3 bg-gray-50 border-t border-gray-200 flex items-center justify-end rounded-b-lg">
                            <button type="submit" id="payfast-submit" class="bg-indigo-600 hover:bg-black text-white text-sm font-medium py-2 px-4 rounded-sm shadow-sm transition-colors focus:ring-2 focus:ring-offset-2 focus:ring-gray-900">
                                Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="modal-sub" class="modal-pane hidden">
                <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
                    <div class="bg-gray-50 border-b border-gray-200 px-4 py-3 flex items-center justify-between rounded-t-lg">
                        <h3 class="text-gray-900 font-semibold text-sm">Subscription Status</h3>
                        <div class="flex items-center gap-1.5 px-2 py-0.5 rounded text-xs font-medium border {% if days_left > 0 %}text-emerald-700 bg-emerald-50 border-emerald-200{% else %}text-red-700 bg-red-50 border-red-200{% endif %}">
                            <i class="fa-solid fa-credit-card text-[10px]"></i>
                            <span>{% if days_left > 0 %}Active{% else %}Expired{% endif %}</span>
                        </div>
                    </div>

                    <div class="p-4 space-y-6 bg-white">
                        <div class="flex justify-between items-center bg-slate-900 text-white p-6 rounded-sm shadow-lg">
                            <div>
                                <p class="text-[10px] font-bold uppercase opacity-60">Time Remaining</p>
                                <p class="text-4xl font-black uppercase">{{ days_left }} Days</p>
                            </div>
                            <div class="text-right">
                                <p class="text-[10px] font-bold uppercase opacity-60">Status</p>
                                <p class="font-bold text-sm uppercase {% if days_left > 0 %}text-emerald-400{% else %}text-red-400{% endif %}">
                                    {% if days_left > 0 %}Active{% else %}Expired{% endif %}
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="px-4 py-3 bg-gray-50 border-t border-gray-200 flex flex-col md:flex-row items-center justify-between gap-4 rounded-b-lg">
                        <p class="text-[11px] text-gray-500">
                            Renewal adds 30 days to your current expiry date so no days lost on early renewal.
                        </p>
                        <a href="{{ pay_url }}" class="bg-indigo-600 hover:bg-black text-white text-sm font-medium py-2 px-4 rounded-sm shadow-sm transition-colors text-center w-full md:w-auto">
                            {# Dynamic price based on the business plan #}
                            Renew Subscription (R{{ subscription_price|floatformat:0 }} / 30 Days)
                        </a>
                    </div>
                </div>
            </div>

            <div id="modal-refer" class="modal-pane hidden">
                <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
                    <div class="bg-gray-50 border-b border-gray-200 px-4 py-3 flex items-center justify-between rounded-t-lg">
                        <h3 class="text-gray-900 font-semibold text-sm">Referral Program</h3>
                        <div class="flex items-center gap-1.5 px-2 py-0.5 rounded text-xs font-medium text-amber-700 bg-amber-50 border border-amber-200">
                            <i class="fa-solid fa-gift text-[10px]"></i>
                            <span>Rewards</span>
                        </div>
                    </div>

                    <div class="p-8 bg-white text-center">
                        <div class="w-14 h-14 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i class="fa-solid fa-gift text-2xl"></i>
                        </div>
                        <p class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-4">Your Referral Code</p>

                        <div class="bg-gray-50 border border-gray-200 rounded-sm p-4 mb-6 inline-block">
                            <code class="text-3xl font-black text-gray-900 tracking-widest">{{ business.referral_code }}</code>
                        </div>

                        <div class="max-w-xs mx-auto">
                            <button onclick="copyReferralCode('{{ business.referral_code }}', this)" class="w-full bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 font-medium py-3 px-4 rounded-sm shadow-sm text-sm transition-colors">
                                Copy Code to Clipboard
                            </button>
                        </div>

                        <p class="text-[11px] text-gray-400 mt-6 leading-relaxed">Share this code with other business owners.<br>When they subscribe, you both get +30 days free.</p>
                    </div>

                    <div class="bg-gray-50 border-t border-gray-200 h-2 rounded-b-lg"></div>
                </div>
            </div>

        </div>
    </div>
</div>

<div id="calendar-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
    <div class="bg-white w-full max-w-md animate-fade-up shadow-2xl rounded-md overflow-hidden">
        <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
            <div>
                <span class="mini-heading block">Agenda</span>
                <h3 id="modal-date-title" class="text-lg font-bold text-slate-900">Date Details</h3>
            </div>
            <button onclick="closeModal()" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-slate-200 text-slate-400 transition-colors">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
        </div>
        <div id="modal-body" class="p-4 space-y-3 max-h-[60vh] overflow-y-auto"></div>
    </div>
</div>

<div id="helpModal2" class="fixed inset-0 z-[60] hidden items-center justify-center p-0 md:p-4 font-sans">
    <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity" onclick="toggleHelpModal2()"></div>

    <div class="relative bg-white w-full max-w-5xl h-full md:max-h-[90vh] animate-fade-up flex flex-col overflow-hidden md:rounded-md shadow-2xl">

        <div class="px-6 md:px-8 py-3 border-b border-slate-100 flex justify-between items-center bg-white shrink-0">
            <div>
                <span class="text-indigo-600 text-xs font-bold uppercase tracking-wider mb-1 block">Owner Manual</span>
                <h2 class="text-2xl font-bold text-slate-900">Business Settings</h2>
            </div>
            <button onclick="toggleHelpModal2()" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-slate-100 text-slate-400 transition-colors">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
        </div>

        <div class="overflow-y-auto flex-1 bg-white p-6 md:p-10 space-y-12">

            <section>
                <div class="flex items-center gap-3 mb-6">
                    <div class="text-indigo-600 text-xl"><i class="fa-solid fa-users"></i></div>
                    <h3 class="font-bold text-slate-900 text-xl uppercase tracking-tight">Team Management</h3>
                </div>

                <div class="pl-4 md:pl-8 border-l-2 border-slate-100 space-y-4">
                    <p class="text-base text-slate-600 leading-relaxed">
                        We use a secure <strong>Join Code</strong> system. You do not create passwords for your staff; they manage their own login details.
                    </p>

                    <div class="bg-slate-50 p-6 rounded-md border border-slate-100">
                        <h4 class="text-xs font-bold uppercase text-slate-500 mb-4 tracking-widest">Onboarding Process:</h4>
                        <div class="grid md:grid-cols-2 gap-6">
                            <ol class="space-y-3 text-sm text-slate-700">
                                <li class="flex gap-3">
                                    <span class="flex-shrink-0 w-6 h-6 bg-indigo-600 text-white rounded-full flex items-center justify-center text-[10px] font-bold">1</span>
                                    <span>Staff member creates an account on the <strong>Register</strong> page.</span>
                                </li>
                                <li class="flex gap-3">
                                    <span class="flex-shrink-0 w-6 h-6 bg-indigo-600 text-white rounded-full flex items-center justify-center text-[10px] font-bold">2</span>
                                    <span>They select <strong>"Join Existing Business"</strong>.</span>
                                </li>
                            </ol>
                            <ol class="space-y-3 text-sm text-slate-700">
                                <li class="flex gap-3">
                                    <span class="flex-shrink-0 w-6 h-6 bg-indigo-600 text-white rounded-full flex items-center justify-center text-[10px] font-bold">3</span>
                                    <span>They enter the <code class="bg-indigo-100 text-indigo-700 px-1.5 py-0.5 rounded font-bold uppercase">Join Code</code> found on your Team tab.</span>
                                </li>
                                <li class="flex gap-3 text-emerald-600 font-medium">
                                    <i class="fa-solid fa-circle-check mt-1"></i>
                                    <span>They appear in your "Active Members" list and can view assigned bookings instantly.</span>
                                </li>
                            </ol>
                        </div>
                    </div>
                </div>
            </section>

            <section>
                <div class="flex items-center gap-3 mb-6">
                    <div class="text-emerald-600 text-xl"><i class="fa-solid fa-link"></i></div>
                    <h3 class="font-bold text-slate-900 text-xl uppercase tracking-tight">Booking Portals</h3>
                </div>

                <div class="pl-4 md:pl-8 border-l-2 border-slate-100 space-y-8">
                    <div class="flex flex-col md:flex-row gap-4 md:gap-10">
                        <div class="flex-1">
                            <h4 class="text-base font-bold text-slate-900 mb-2">Direct Link & Public Page</h4>
                            <p class="text-sm text-slate-600 leading-relaxed">
                                A standalone webpage hosted by us. It displays your services, business details, and client reviews.
                                <span class="block mt-2 font-semibold text-slate-700"><i class="fa-brands fa-whatsapp text-emerald-500 mr-1"></i> Best for WhatsApp, Instagram Bio, or if you don't have a website.</span>
                            </p>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-base font-bold text-slate-900 mb-2">Website Integration (Embed)</h4>
                            <p class="text-sm text-slate-600 leading-relaxed">
                                A smooth popup experience where users stay on <strong>your</strong> website while booking.
                                <span class="block mt-2 font-semibold text-slate-700"><i class="fa-solid fa-code text-indigo-500 mr-1"></i> Best for Wix, WordPress, or Custom sites.</span>
                            </p>
                        </div>
                    </div>
                </div>
            </section>

            <section>
                <div class="flex items-center gap-3 mb-6">
                    <div class="text-slate-700 text-xl"><i class="fa-solid fa-sliders"></i></div>
                    <h3 class="font-bold text-slate-900 text-xl uppercase tracking-tight">Settings & Configuration</h3>
                </div>

                <div class="pl-4 md:pl-8 border-l-2 border-slate-100">
                    <div class="grid md:grid-cols-2 gap-x-12 gap-y-8">
                        <div>
                            <h5 class="text-sm font-bold text-amber-600 uppercase tracking-wide mb-2 flex items-center gap-2">
                                <i class="fa-solid fa-scissors"></i> Services
                            </h5>
                            <p class="text-sm text-slate-600">The engine of your dashboard. Add, Edit, or Delete services at any time. Changes update immediately across all booking links.</p>
                        </div>

                        <div>
                            <h5 class="text-sm font-bold text-indigo-600 uppercase tracking-wide mb-2 flex items-center gap-2">
                                <i class="fa-regular fa-credit-card"></i> Payments & Deposits
                            </h5>
                            <p class="text-sm text-slate-600">Connect your <strong>PayFast</strong> credentials to require deposits. Leave empty to allow free bookings.</p>
                        </div>

                        <div>
                            <h5 class="text-sm font-bold text-red-600 uppercase tracking-wide mb-2 flex items-center gap-2">
                                <i class="fa-regular fa-calendar-xmark"></i> Schedule Control
                            </h5>
                            <p class="text-sm text-slate-600">Manage <strong>Operating Hours</strong> and <strong>Block Dates</strong> (holidays/days off) to prevent unwanted bookings.</p>
                        </div>

                        <div>
                            <h5 class="text-sm font-bold text-purple-600 uppercase tracking-wide mb-2 flex items-center gap-2">
                                <i class="fa-solid fa-gift"></i> Referral Rewards
                            </h5>
                            <p class="text-sm text-slate-600">Share your code. If another business signs up, <strong>you BOTH get 30 days of free subscription</strong> automatically.</p>
                        </div>
                    </div>
                </div>
            </section>

        </div>

        <div class="p-6 border-t border-slate-100 bg-slate-50 flex justify-end items-center shrink-0">
            <button onclick="toggleHelpModal2()" class="px-8 py-2 bg-slate-900 text-white text-xs font-black uppercase tracking-[0.2em] rounded hover:bg-slate-800 transition-all active:scale-95 shadow-lg">
                Got it
            </button>
        </div>
    </div>
</div>
<div id="helpModal" class="fixed inset-0 hidden items-center justify-center z-[60] p-4 bg-slate-900/50 backdrop-blur-sm">
    <div class="bg-white p-8 max-w-md w-full animate-fade-up rounded-md shadow-xl">
        <h3 class="font-bold text-xl text-slate-900 mb-4">How it works</h3>
        <p class="text-slate-500 text-sm leading-relaxed mb-6">
            The website form creates a seamless popup window on your existing website, exactly how this message popped up. This keeps users on your page while they book. If you don't have a website and need one, contact support and we will sort you out!
        </p>
        <button onclick="closeHelpModal()" class="btn-main w-full justify-center">Got It</button>
    </div>
</div>

<div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 z-[100] px-6 py-3 bg-slate-800 text-white font-bold text-[10px] uppercase tracking-wider rounded-full shadow-2xl opacity-0 transition-all duration-300 pointer-events-none transform translate-y-4">
    Action Successful
</div>

<script>
    // --- 1. DATA PREP ---
    const allAppointments = [];
    function pushAppointment(id, name, service, date, time, status, detailUrl) {
        allAppointments.push({ id, name, service, date, time, status, detailUrl });
    }

    {% for appt in today_appointments %}
    pushAppointment("{{ appt.pk }}", "{% if appt.customer %}{{ appt.customer.name|default:appt.customer.name|escapejs }}{% else %}{{ appt.guest_name|escapejs }} (Guest){% endif %}", "{{ appt.service.name|escapejs }}", "{{ appt.appointment_date|date:'Y-m-d' }}", "{{ appt.appointment_start_time|time:'H:i' }}", "{{ appt.status }}", "{% url 'appointment_detail' appt.pk %}");
    {% endfor %}
    {% for appt in upcoming_appointments %}
    pushAppointment("{{ appt.pk }}", "{% if appt.customer %}{{ appt.customer.name|default:appt.customer.name|escapejs }}{% else %}{{ appt.guest_name|escapejs }} (Guest){% endif %}", "{{ appt.service.name|escapejs }}", "{{ appt.appointment_date|date:'Y-m-d' }}", "{{ appt.appointment_start_time|time:'H:i' }}", "{{ appt.status }}", "{% url 'appointment_detail' appt.pk %}");
    {% endfor %}
    {% for appt in past_appointments %}
    pushAppointment("{{ appt.pk }}", "{% if appt.customer %}{{ appt.customer.name|default:appt.customer.name|escapejs }}{% else %}{{ appt.guest_name|escapejs }} (Guest){% endif %}", "{{ appt.service.name|escapejs }}", "{{ appt.appointment_date|date:'Y-m-d' }}", "{{ appt.appointment_start_time|time:'H:i' }}", "{{ appt.status }}", "{% url 'appointment_detail' appt.pk %}");
    {% endfor %}

    // --- 2. TABS LOGIC ---
    let calendar;

    function switchDashTab(evt, tabId) {
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
        document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.remove('hidden');
        const clickedBtn = evt.currentTarget;
        clickedBtn.classList.add('active');
        if(tabId === 'dash-calendar' && calendar) {
            setTimeout(() => calendar.updateSize(), 50);
        }
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // --- 3. CALENDAR INIT ---
    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        if (calendarEl) {
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: { left: 'prev,next', center: 'title', right: 'today' },
                dayMaxEvents: 2,
                height: 'auto',
                events: allAppointments.map(a => ({
                    title: a.name,
                    start: `${a.date}T${a.time}`,
                    backgroundColor: a.status === 'confirmed' ? '#4f46e5' : '#cbd5e1',
                    borderColor: 'transparent',
                    textColor: a.status === 'confirmed' ? '#fff' : '#475569',
                    extendedProps: { detailUrl: a.detailUrl, service: a.service, status: a.status }
                })),
                eventClick: (info) => openDateModal(info.event.startStr.split('T')[0]),
                dateClick: (info) => openDateModal(info.dateStr),
            });
            calendar.render();
        }
        const firstTab = document.querySelector('.nav-tab');
        if(firstTab) firstTab.classList.add('active');
    });

    // --- 4. MODALS & UTILS ---
    function openDateModal(dateStr) {
        const modal = document.getElementById('calendar-modal');
        const body = document.getElementById('modal-body');
        const selectedDate = dateStr.includes('T') ? dateStr.split('T')[0] : dateStr;

        const dateObj = new Date(selectedDate + 'T00:00:00');
        document.getElementById('modal-date-title').innerText = dateObj.toLocaleDateString(undefined, { weekday: 'long', month: 'short', day: 'numeric' });

        const dayAppts = allAppointments.filter(a => a.date === selectedDate).sort((a,b) => a.time.localeCompare(b.time));

        if (dayAppts.length > 0) {
            body.innerHTML = dayAppts.map(a => `
                <div class="bg-white p-4 rounded-md border border-slate-100 flex items-center justify-between hover:border-indigo-200 transition-colors shadow-sm">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-sm font-bold text-slate-900">${a.time}</span>
                            <span class="text-[9px] font-bold uppercase px-2 py-0.5 rounded ${a.status==='confirmed' ? 'bg-indigo-50 text-indigo-600' : 'bg-amber-50 text-amber-600'}">${a.status}</span>
                        </div>
                        <h4 class="font-bold text-sm text-slate-700">${a.name}</h4>
                        <p class="text-xs text-slate-400">${a.service}</p>
                    </div>
                </div>
            `).join('');
        } else {
            body.innerHTML = `<div class="py-12 text-center text-slate-300 font-bold uppercase text-xs">No bookings for this date</div>`;
        }
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function closeModal() {
        document.getElementById('calendar-modal').classList.add('hidden');
        document.getElementById('calendar-modal').classList.remove('flex');
    }

    function openSettingsModal(paneId, title) {
        const overlay = document.getElementById('settings-modal-overlay');
        const container = document.getElementById('settings-modal-container');

        // 1. Hide all panes
        document.querySelectorAll('.modal-pane').forEach(p => p.classList.add('hidden'));

        // 2. Show the requested pane
        document.getElementById(paneId).classList.remove('hidden');

        // 3. Set Title
        document.getElementById('modal-display-title').innerText = title;

        // 4. Start Animation Sequence
        // Remove 'hidden' so it renders
        overlay.classList.remove('hidden');
        overlay.classList.add('flex');
        document.body.style.overflow = 'hidden';

        // Add a tiny delay to allow the browser to recognize the element is now in DOM
        // so the opacity/transform transitions trigger correctly.
        setTimeout(() => {
            overlay.classList.remove('opacity-0');
            container.classList.remove('scale-95', 'opacity-0');
            container.classList.add('scale-100', 'opacity-100');
        }, 10);
    }

    function closeSettingsModal() {
        const overlay = document.getElementById('settings-modal-overlay');
        const container = document.getElementById('settings-modal-container');

        // 1. Revert Animation States
        overlay.classList.add('opacity-0');
        container.classList.add('scale-95', 'opacity-0');
        container.classList.remove('scale-100', 'opacity-100');

        // 2. Wait for transition to finish (300ms matches duration-300) before hiding
        setTimeout(() => {
            overlay.classList.add('hidden');
            overlay.classList.remove('flex');
            document.body.style.overflow = '';
        }, 300);
    }

    function showToast(msg) {
        const toast = document.getElementById('toast');
        toast.innerText = msg;
        toast.style.opacity = '1';
        toast.style.transform = 'translate(-50%, 0)';
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translate(-50%, 1rem)';
        }, 3000);
    }

    function copyAction(id) {
        const input = document.getElementById(id);
        input.select();
        navigator.clipboard.writeText(input.value).then(() => showToast("Link Copied"));
    }

    function copyJoinCode(btn) {
        const code = document.getElementById('joinCodeText').innerText;
        navigator.clipboard.writeText(code).then(() => showToast("Staff Join Code Copied"));
    }

    function copyReferralCode(code, btn) {
        navigator.clipboard.writeText(code).then(() => showToast("Referral Code Copied"));
    }

    function openInstagramApp(url) {
        navigator.clipboard.writeText(url).then(() => {
            showToast("Link Copied - Open Instagram");
            setTimeout(() => window.location.href = "instagram://camera", 1000);
        });
    }

    function openHelpModal() { document.getElementById('helpModal').classList.remove('hidden'); document.getElementById('helpModal').classList.add('flex'); }
    function closeHelpModal() { document.getElementById('helpModal').classList.add('hidden'); document.getElementById('helpModal').classList.remove('flex'); }

    function toggleHelpModal2() {
        const m = document.getElementById('helpModal2');
        if(m.classList.contains('hidden')) {
            m.classList.remove('hidden'); m.classList.add('flex'); document.body.style.overflow = 'hidden';
        } else {
            m.classList.add('hidden'); m.classList.remove('flex'); document.body.style.overflow = '';
        }
    }

    function copyEmbedSnippet(businessSlug, buttonId) {
    // Construct the URL based on the current domain and the business slug
    const bookingUrl = `${window.location.origin}/book/${businessSlug}/`;
    const embedUrl = `${bookingUrl}?embed=true`;

    const snippet = `
<button onclick="openGMB()" style="background:#4f46e5;color:#fff;padding:12px 24px;border:0;cursor:pointer;font-family:sans-serif;font-weight:700;text-transform:uppercase;font-size:12px;border-radius:6px;transition:background 0.2s;" onmouseover="this.style.background='#4338ca'" onmouseout="this.style.background='#4f46e5'">Book Now</button>
<script>(function(){if(window.openGMB)return;const s=document.createElement('style');s.textContent='.gmb-o{position:fixed;inset:0;background:rgba(15,23,42,0.6);backdrop-filter:blur(4px);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px}.gmb-w{width:100%;max-width:500px;height:85vh;background:#fff;position:relative;border-radius:12px;overflow:hidden;box-shadow:0 25px 50px -12px rgba(0,0,0,0.25)}.gmb-f{width:100%;height:100%;border:0}.gmb-c{position:absolute;top:15px;right:15px;background:#f1f5f9;color:#64748b;border:0;width:32px;height:32px;cursor:pointer;z-index:10000;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;transition:all 0.2s} .gmb-c:hover{background:#e2e8f0;color:#0f172a}';document.head.appendChild(s);window.openGMB=function(){if(document.getElementById('gmb-o'))return;const d=document.createElement('div');d.id='gmb-o';d.className='gmb-o';d.innerHTML='<div class="gmb-w"><iframe class="gmb-f" src="${embedUrl}"></iframe><button class="gmb-c" onclick="closeGMB()">Ã—</button></div>';document.body.appendChild(d);document.body.style.overflow='hidden'};window.closeGMB=function(){const el=document.getElementById('gmb-o');if(el)el.remove();document.body.style.overflow=""}})()<\/script>`;

    navigator.clipboard.writeText(snippet.trim()).then(() => {
        const btn = document.getElementById(buttonId);
        const originalText = btn.innerText;
        btn.innerText = 'âœ“ Copied Code';
        btn.classList.add('bg-emerald-50', 'text-emerald-600', 'border-emerald-200');

        setTimeout(() => {
            btn.innerText = originalText;
            btn.classList.remove('bg-emerald-50', 'text-emerald-600', 'border-emerald-200');
        }, 2000);
    });
}
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const depositTypeSelect = document.getElementById('deposit_type_select');
    const fixedContainer = document.getElementById('fixed_amount_container');
    const percentageContainer = document.getElementById('percentage_container');

    function toggleDepositFields() {
        if (depositTypeSelect.value === 'percentage') {
            fixedContainer.classList.add('hidden');
            percentageContainer.classList.remove('hidden');
        } else {
            fixedContainer.classList.remove('hidden');
            percentageContainer.classList.add('hidden');
        }
    }

    // Listen for changes
    depositTypeSelect.addEventListener('change', toggleDepositFields);

    // Run on load to show the correct field based on saved data
    toggleDepositFields();
});
</script>
{% endblock %}